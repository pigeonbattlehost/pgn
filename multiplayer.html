<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pigeon Battle - Multiplayer</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #003300; /* Темно-зеленый фон */
    }
    #joystick-container {
      position: absolute;
      bottom: 70px;  /* Позиционируем джойстик ближе к низу */
      left: 60px;
      transform: translateX(-50%);  /* Центрируем по горизонтали */
    }
    #waiting-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 24px;
      text-align: center;
      display: block; /* Убедимся, что текст сразу виден */
    }
    #pigeon-image {
      position: absolute;
      top: 50%; /* Установим по центру экрана */
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px; /* Размер изображения пижона */
      display: block; /* Убедимся, что изображение пижона всегда отображается */
    }
  </style>
  <!-- Подключаем nipplejs с CDN -->
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.2/dist/nipplejs.min.js"></script>
</head>
<body>
  <div id="waiting-text">Waiting for pigeon...</div>
  <div id="joystick-container"></div>
  <img id="pigeon-image" src="" alt="Selected Pigeon" style="display: none;">
  
  <script>
    alert("WARNING! This is a beta version of multiplayer. This version can crash, dont even work and other stuff..  So, report any bugs: ludchoble (discord)")
    let playerData = {
      x: 0,
      y: 0,
      hp: localStorage.getItem('player_hp') || 100, // Получаем ХП из localStorage
      pigeon: localStorage.getItem('selectedPigeon') || "defaultPigeon" // Получаем пигеона
    };

    const pigeons = {
      default: { img: 'pigeon.jpg', speed: 5, attack: 10, damage: 0.3, hp: 1200, shootType: 'normal_shoot' },
      wheelPigeon: { img: 'wheelpigeon.jpg', speed: 7, attack: 2, damage: 0.8, hp: 1000, shootType: 'normal_shoot' },
      radioPigeon: { img: 'radiopigeon.jpg', speed: 5, attack: 10, damage: 0, radiation: true, hp: 1120, shootType: 'normal_shoot' },
      pigeonCopter: { img: 'pigobomb.jpg', speed: 6, attack: 20, damage: 1.5, hp: 1330, shootType: 'normal_shoot' },
      feetPigeon: { img: 'feetpigeon.jpg', speed: 5, attack: 6, damage: 1, kick: true, hp: 1500, shootType: 'normal_shoot' },
      doublePigeon: { img: 'digeon.jpg', speed: 5, attack: 10, damage: 0.6, hp: 1400, shootType: 'normal_shoot' },
      emiPigeon: { img: 'emipigeon.jpg', speed: 5, attack: 8, damage: 0.655, hp: 1200, shootType: 'emishoot' },
      dentistPigeon: { img: 'dentistpigeon.jpg', speed: 5, attack: 10, damage: 0.55, hp: 2000, shootType: 'normal_shoot' },
      armyPigeon: { img: 'armypigeon.jpg', speed: 5, attack: 12, damage: 0.55, hp: 1300, shootType: 'green_short' },
      sorrelPigeon: { img: 'sorrelpigeon.jpg', speed: 6.5, attack: 16, damage: 0.5, hp: 1500, shootType: 'green_short' },
      goonPigeon: { img: 'goonpigeon.jpg', speed: 4.5, attack: 13, damage: 0.56, hp: 1250, shootType: 'white_shoot', humanLegs: true, confusionAura: true }
    };

    // Здесь указываем правильный URL сервера
    const serverUrl = 'https://pigeonbattle.onrender.com';

    let joystick = nipplejs.create({
      zone: document.getElementById('joystick-container'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: 'green'
    });

    joystick.on('move', (event, data) => {
      // Управление движением через джойстик
      playerData.x += data.vector.x * 10; // Умножаем на коэффициент для скорости
      playerData.y -= data.vector.y * 10;
      updatePosition();
    });

    // Управление через клавиши WASD
    window.addEventListener('keydown', (event) => {
      switch(event.key) {
        case 'w':
          playerData.y -= 10;
          break;
        case 'a':
          playerData.x -= 10;
          break;
        case 's':
          playerData.y += 10;
          break;
        case 'd':
          playerData.x += 10;
          break;
      }
      updatePosition();
    });

    function updatePosition() {
      // Обновление позиции пижона
      const pigeonImage = document.getElementById('pigeon-image');
      pigeonImage.style.left = `${playerData.x}px`;
      pigeonImage.style.top = `${playerData.y}px`;

      // Отправка обновлений позиции на сервер
      fetch(`${serverUrl}/update_position`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(playerData)
      }).catch(error => console.error("Error sending position:", error));
    }

    function checkMultiplayerStatus() {
      // Запрос на сервер, чтобы проверить статус мультиплеера
      fetch(`${serverUrl}/multiplayer`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'waiting') {
            document.getElementById('waiting-text').style.display = 'block';
          } else {
            document.getElementById('waiting-text').style.display = 'none';
          }
        })
        .catch(error => console.error("Error fetching multiplayer status:", error));
    }

    // Запросить статус мультиплеера при загрузке
    checkMultiplayerStatus();
    setInterval(checkMultiplayerStatus, 3000); // Проверять каждые 3 секунды

    // Отправка пинга на сервер
    fetch(`${serverUrl}/ping`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        player_id: 'some-player-id' // передаем сюда player_id
      })
    }).then(response => response.json())
      .then(data => console.log(data))
      .catch(error => console.error("Error sending ping:", error));

    // Функция для отображения картинки выбранного пижона
    function displayPigeonImage() {
      const pigeon = pigeons[playerData.pigeon];
      const pigeonImage = document.getElementById('pigeon-image');
      pigeonImage.src = pigeon.img;
      pigeonImage.style.display = 'block'; // Показываем картинку
    }

    // Отображаем картинку пижона сразу после загрузки
    displayPigeonImage();

    // Проверка выигрыша
    function checkGameOutcome() {
      // Пример: если пижон побеждает, показываем alert и прибавляем +10 к монетам
      let gameResult = "win"; // Или "lose" в случае проигрыша
      if (gameResult === "win") {
        alert("You win! +10 coins");
        let pigeonCoins = parseInt(localStorage.getItem('pigeonCoins')) || 0;
        pigeonCoins += 10;
        localStorage.setItem('pigeonCoins', pigeonCoins);
      } else {
        alert("You lose! Better luck next time!");
      }
    }
  </script>
</body>
</html>