<!-- <!DOCTYPE html> -->
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pigeon Battle</title>
  <style>
      
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }
    #splash {
  font-family: 'Orbitron', sans-serif;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: black;
  color: white;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.achievement {
  position: fixed;
  top: -80px; 
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(180deg, #111, #1b1b1b);
  color: #fff;
  font-weight: 700;
  padding: 14px 24px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  transition: top 0.6s ease;
  z-index: 9999;
}
.achievement.show {
  top: 20px;
}

    #loadingText {
  position: absolute;
  bottom: 30px;
  width: 100%;
  text-align: center;
  font-size: 1.1em;
  color: #ccc;
  font-family: 'Poppins', sans-serif;
  animation: blink 1.2s infinite;
}

@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}

    #menu, #shop, #pigeonsMenu {
      position: absolute;
      width: 100%;
      height: 100%;
      background: #000;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #pigeonsMenu {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  height: 100%;
  overflow-y: auto;
  padding: 10px;
}
    #menu h1, #shop h2 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    #menu button, #shop button, #pigeonsMenu button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #playButton { background: #00aaff; color: white; }
    #shopButton { background: #ffaa00; color: black; }
    #pigeonsButton { background: #aaa; color: black; }

    #gameContainer { 
    display: none; 
    width: 100%; 
    height: 100%; 
    position: relative; 
}

    canvas { 
    display: block; 
    width: 100%; 
    height: 100%; 
    background-image: url("bg.jpg");
    background-size: cover;
    background-position: center;
    background-size: cover;
    background-position: center;
}

    #version {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 14px;
      color: white;
    }
    
    #shop img, .pigeon-card img {
      max-width: 200px;
      border-radius: 15px;
      margin: 10px;
    }
    .pigeon-card {
      margin: 20px;
      text-align: center;
    }
    #joystick, #shootBtn, #shootJoystick {
      position: absolute;
      display: none;
    }
    #joystick {
      left: 20px;
      bottom: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      touch-action: none;
    }
    #shootJoystick {
      right: 100px;
      bottom: 20px;
      width: 100px;
      height: 100px;
      background: rgba(255,0,0,0.2);
      border-radius: 50%;
      touch-action: none;
    }
    #shootBtn {
      right: 20px;
      bottom: 30px;
      width: 60px;
      height: 60px;
      background: red;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      text-align: center;
      line-height: 60px;
    }

    #superbangBtn {
      left: 20px;
      bottom: 140px;
      width: 130px;
      height: 44px;
      background: #ffd84d;
      border-radius: 12px;
      color: #000;
      font-weight: 800;
      display: none;
      position: absolute;
      text-align: center;
      line-height: 44px;
      z-index: 2000;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      user-select: none;
    }
    #superbangBtn.disabled {
      opacity: 0.45;
      pointer-events: none;
    }

    #coinsDisplay {
      margin-bottom: 10px;
      font-size: 18px;
    }
    #onlineStatus {
      position: absolute;
      bottom: 10px;
      left: 10px;
      padding: 5px 10px;
      background: #444;
      border-radius: 20px;
      font-size: 14px;
      color: white;
    }
    
    

#pigeonRankDisplay {
  position: absolute;
  bottom: 35px;
  right: 10px;
  font-size: 14px;
  font-weight: bold;
  font-family: 'Poppins', sans-serif;
  color: gray;
}


  #shop {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    height: 100%;
    overflow-y: auto;
    padding: 10px;

  }
  
  #about-btn {
  background-color: #6200ea;ff
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 15px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.about-btn:hover {
  background-color: #7b1fa2;
}

.pigeonism-btn {
  background-color: #357a87;
  color: white;
  border: 2px solid #2f6e7d;
  border-radius: 10px;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pigeonism-btn:hover {
  background-color: #2f6e7d;
  border-color: #4f9dc6;
  transform: scale(1.05);
}

.pigeonism-btn:active {
  background-color: #2a5762;
  transform: scale(0.98);
}


.pigeon-card img {
  max-width: 75%;
  max-height: 150px;
  object-fit: contain;
}

.pigeon-container {
    display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  height: 100%;
  overflow-y: auto;
  padding: 10px;
}

h1, h2, h3 {
  font-family: 'Poppins', sans-serif;
}


  
/* SELL DIALOG (custom styles) */
.sell-dialog {
  position: fixed;
  inset: 0;
  display: none; /* toggle via JS */
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.45);
  z-index: 20000;
}
.sell-card {
  background: linear-gradient(180deg,#0b1220,#0f1724);
  color: #fff;
  padding: 18px 20px;
  border-radius: 18px;
  min-width: 260px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  font-family: 'Poppins', sans-serif;
}
#sellText { font-weight:700; margin-bottom:10px; font-size:16px; }
#sellDots { display:inline-block; width:60px; }
@keyframes sell-pulse {
  0% { transform: scale(1); opacity: 0.6 }
  50% { transform: scale(1.06); opacity: 1 }
  100% { transform: scale(1); opacity: 0.6 }
}
.sell-spinner { display:inline-block; margin-left:6px; width:8px; height:8px; border-radius:50%; background:#fff; animation: sell-pulse 1s infinite; }
.sell-time { margin-top:8px; font-size:13px; color:#cbd5e1; }

    /* === CASE RESULT OVERLAY === */
    #caseResultOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: 'Poppins', sans-serif;
      z-index: 30000;
      text-align: center;
      animation: fadeIn 0.5s ease forwards;
    }
    #caseResultOverlay h1 {
      font-size: 3em;
      margin-bottom: 10px;
      animation: bounceIn 0.6s ease;
    }
    #caseResultOverlay p {
      font-size: 2em;
      margin-top: 0;
      animation: fadeInUp 0.8s ease;
    }
    #caseResultOverlay img {
      max-width: 220px;
      margin: 20px;
      border-radius: 18px;
      animation: zoomIn 0.7s ease;
    }
    #caseCloseBtn {
      margin-top: 20px;
      font-size: 1.4em;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: #ffaa00;
      color: black;
    }

    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(40px)} to {opacity:1; transform:translateY(0)} }
    @keyframes bounceIn {
      0% { transform:scale(0.3); opacity:0 }
      50% { transform:scale(1.05); opacity:1 }
      70% { transform:scale(0.9) }
      100% { transform:scale(1) }
    }
    @keyframes zoomIn { from {transform:scale(0.3); opacity:0} to {transform:scale(1); opacity:1} }


/* === BATTLE RESULT OVERLAY === */
#battleResultOverlay {
  position: fixed;
  inset: 0;
  background: rgba(8,8,12,0.92);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-family: 'Poppins', sans-serif;
  z-index: 35000;
  text-align: center;
  padding: 20px;
  animation: fadeIn 0.35s ease forwards;
}
#battleResultCard {
  background: linear-gradient(180deg, rgba(10,14,18,0.95), rgba(20,24,30,0.96));
  border-radius: 18px;
  padding: 26px;
  min-width: 320px;
  max-width: 720px;
  box-shadow: 0 18px 50px rgba(0,0,0,0.6);
  transform-origin: center center;
  animation: popIn 0.45s cubic-bezier(.2,.9,.3,1);
}
#battleResultOverlay h1 {
  font-size: 2.4em;
  margin: 0 0 6px 0;
  letter-spacing: 1px;
}
#battleResultOverlay .subtext {
  font-size: 1.05em;
  margin-bottom: 10px;
  opacity: 0.95;
}
#battleResultOverlay .rewards {
  margin-top: 12px;
  font-size: 1.05em;
  line-height: 1.6;
}
#battleResultOverlay .rewards span { display:block; }
#battleResultOverlay .btn-row {
  margin-top: 16px;
  display:flex;
  gap:12px;
  justify-content:center;
}
.battle-btn {
  padding: 10px 18px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 1em;
}
.battle-btn.primary { background: #1bd760; color: #00310a; }
.battle-btn.secondary { background: #2a2f38; color: #fff; }

@keyframes popIn {
  0% { transform: scale(0.9); opacity: 0 }
  60% { transform: scale(1.03); opacity: 1 }
  100% { transform: scale(1); opacity: 1 }
}


/* ===== Mobile-friendly UI tweaks (scale down menus/overlays but keep game controls size) ===== */
@media (max-width: 600px) {
  /* Menu / shop / lists */
  #menu h1, #menu h3 { font-size: 1.4rem; }
  #menu h1 { margin-bottom:6px; }
  #menu button, #shop button, #pigeonsMenu button, .pigeonism-btn, #about-btn {
    font-size: 0.95rem;
    padding: 6px 10px;
    margin: 3px 2px;
    border-radius: 10px;
  }
  #coinsDisplay, #onlineStatus, #pigeonRankDisplay, #version { font-size: 13px; }
  #menu { padding: 10px; gap: 6px; }
  .pigeon-card { margin: 8px; }
  .pigeon-card img { max-height: 110px; max-width: 70%; }

  /* Case result and battle overlays — smaller but readable */
  #caseResultOverlay h1, #battleResultOverlay h1 { font-size: 1.8rem; margin-bottom:6px; }
  #caseResultOverlay p, #battleResultOverlay .subtext, #caseResultOverlay p#caseResultText {
    font-size: 1rem;
  }
  #caseResultOverlay img, #battleResultOverlay img { max-width: 140px; margin: 12px; }
  #caseCloseBtn, .battle-btn { padding: 8px 12px; font-size: 0.95rem; border-radius: 10px; }

  /* Make result cards fit better on narrow screens */
  #battleResultCard { min-width: 240px; max-width: 94%; padding: 16px; }
  #caseResultOverlay { padding: 12px; }

  /* Dialogs */
  .sell-card, #giftDialog > div { min-width: 200px; max-width: 92%; padding: 12px; border-radius: 12px; }

  /* Toasts and small UI */
  #toast { font-size: 14px; min-width: 160px; padding: 10px; bottom: 18px; }

  /* Shop lists more compact */
  #shop .pigeon-card p, #shop .pigeon-card button { font-size: 0.95rem; }
  #pigeonsMenu { padding: 8px; }


/* ===== Ultra-compact mode for very narrow phones (<=420px) ===== */
@media (max-width: 420px) {
  #menu h1, #menu h3 { font-size: 1.1rem; }
  #menu button, #shop button, #pigeonsMenu button, .pigeonism-btn, #about-btn {
    font-size: 0.8rem;
    padding: 5px 8px;
    margin: 2px;
    border-radius: 8px;
  }
  #coinsDisplay, #onlineStatus, #pigeonRankDisplay, #version { font-size: 11px; }
  .pigeon-card img { max-height: 90px; max-width: 65%; }
  .pigeon-card { margin: 4px; }

  #caseResultOverlay h1, #battleResultOverlay h1 { font-size: 1.4rem; margin-bottom:4px; }
  #caseResultOverlay p, #battleResultOverlay .subtext, #caseResultOverlay p#caseResultText {
    font-size: 0.9rem;
  }
  #caseResultOverlay img, #battleResultOverlay img { max-width: 110px; margin: 8px; }
  #caseCloseBtn, .battle-btn { padding: 6px 8px; font-size: 0.85rem; }

  #battleResultCard { min-width: 200px; max-width: 95%; padding: 10px; }
  #caseResultOverlay { padding: 8px; }

  .sell-card, #giftDialog > div { min-width: 180px; max-width: 90%; padding: 8px; border-radius: 10px; }

  #toast { font-size: 12px; min-width: 140px; padding: 8px; bottom: 14px; }

  #shop .pigeon-card p, #shop .pigeon-card button { font-size: 0.85rem; }
  #pigeonsMenu { padding: 6px; }
}

#newPigeonAchievement {
  position: fixed;
  top: -160px;
  left: 50%;
  transform: translateX(-50%);
  width: 420px;
  max-width: 92%;
  background: linear-gradient(180deg, #111, #1b1b1b);
  border-radius: 14px;
  padding: 14px 16px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  z-index: 60000;
  font-family: 'Poppins', sans-serif;
  overflow: visible;
}
#newPigeonAchievement .text {
  flex: 1;
}

 /* new ui overwrite */
 body, #menu, #shop, #pigeonsMenu, #communityShop {
  background:#000 !important;
  color:#fff !important;
}



button, #shop button, #menu button, #pigeonsMenu button {
  background: linear-gradient(135deg,#0d6efd,#0b5fd6) !important;
  color:#fff !important;
  border:none !important;
  border-radius:12px !important;
  font-weight:700 !important;
  transition:transform .15s ease,box-shadow .15s ease !important;
  box-shadow:0 6px 20px rgba(13,110,253,0.3) !important;
}
button:hover { transform:translateY(-3px) !important; }

#newPigeonAchievement .text .title {
  color: yellow;
  font-weight: 800;
  font-size: 1.05rem;
  margin-bottom: 4px;
}
#newPigeonAchievement .text .name {
  color: #fff;
  font-weight: 700;
  font-size: 0.95rem;
}
#newPigeonAchievement .imgWrap {
  position: relative;
  width: 96px;
  height: 96px;
  margin-left: 8px;
  transform: translateX(18px); /* push image slightly outside the toast to the right */
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  border-radius: 10px;
  overflow: visible;
}
#newPigeonAchievement .imgWrap img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
  transform: scale(1.02);
}
/* animation */
#newPigeonAchievement.show {
  animation: slideDown 0.6s cubic-bezier(.2,.9,.3,1) forwards;
}
#newPigeonAchievement.hide {
  animation: slideUp 0.5s ease forwards;
}
@keyframes slideDown {
  from { top: -160px; opacity: 0; transform: translateX(-50%) translateY(-8px) scale(0.98); }
  to   { top: 24px; opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
}
@keyframes slideUp {
  from { top: 24px; opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
  to   { top: -160px; opacity: 0; transform: translateX(-50%) translateY(-6px) scale(0.98); }
}

</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>

<!-- New pigeon achievement (injected) -->
<div id="newPigeonAchievement" aria-live="polite" role="status" style="display:none;">
  <div class="text">
    <div class="title">New pigeon!</div>
    <div class="name" id="newPigeonName">blackarmyPigeon</div>
  </div>
  <div class="imgWrap"><img id="newPigeonImg" src="blackarmypigeon.jpg" alt="blackarmyPigeon"></div>
</div>

    <div id="splash">
<div id="preloadLog" style="
  position:fixed;
  top:10px;
  left:10px;
  font-size:5px;
  font-family:'Press Start 2P', cursive;
  color: 'white';
  text-shadow:0 0 6px #0f0;
  z-index:99999;
  line-height:1.6em;
  white-space:pre-line;
"></div>
  <h1>PigeonLabs</h1>
  <div id="loadingText">Loading game assets...</div>
</div>


  <div id="menu">
    <h1>Pigen Battle</h1>
    <h3>Winter Update!</h3>
    <div id="coinsDisplay">Coins: 0</div>
    <button id="playButton">Play</button>
    <button id="shopButton">Shop</button>
    <button id="pigeonsButton">Pigeons</button>
    <button class="pigeonism-btn" id="pigeonism-btn">Pigeon Chat</button>
    <button id="about-btn">About</button>
    <button id="goonNFTsButton">GoonNFTs</button>

    
    <div id="onlineStatus">Loading pigeons...</div>
    <div id="pigeonRankDisplay">PigeonRank: 0</div>
  </div>
  
 <div id="shop" style="display:none;">
  <h2>Shop</h2>

  <h3>LAVA SIGEON FOR SALE!!! 16% Sale!</h3>
    <div class="pigeon-card">
    <img src="lavapigeon.jpg">
    <p>
  Lava Pigeon<br>
  HP: 2500<br>
  Damage: 0.75<br>
  <s style="color: gray; font-size: 0.9em;">120</s> 
  <b style="color: yellow; font-size: 1.2em;">100 pigeon coins</b>
</p>
    <button onclick="buy('lavapigeon', 100)">Buy</button>
  </div>
    
    
  <div class="pigeon-card">
    <img src="wheelpigeon.jpg">
    <p>Wheel Pigeon<br>+2 speed<br>+1.5 attack<br>25 pigeon coins</p>
    <button onclick="buy('wheelPigeon', 25)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="dentistpigeon.jpg">
    <p>Dentist Pigeon<br>+0.55 damage<br>+10 attack<br>2000 HP<br>49 pigeon coins</p>
    <button onclick="buy('dentistPigeon', 49)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="armypigeon.jpg">
    <p>Army Pigeon<br>Deals 0.55 dmg<br>55 pigeon coins</p>
    <button onclick="buy('armyPigeon', 55)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="spacepigeon.jpg">
    <p>Space Pigeon<br>Deals 0.452 dmg<br>16 attack<br>1875 HP<br>65 pigeon coins</p>
    <button onclick="buy('spacePigeon', 65)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="goonpigeon.jpg">
    <p>Goon Pigeon<br>Has human legs<br>Causes confusion<br>69 pigeon coins</p>
    <button onclick="buy('goonPigeon', 69)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="pigeoncase.jpg">
    <p>Pigeon Case<br>Random coins or pigeon<br>70 pigeon coins</p>
    <button onclick="openCase()">Buy</button>
    <div id="caseStatus"></div>
  </div>

  <div class="pigeon-card">
    <img src="hipposigeon.jpg">
    <p>Hippo Pigeon<br>HP: 2110<br>Damage: 0.57<br>75 pigeon coins</p>
    <button onclick="buy('hippoPigeon', 75)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="frostbitepigeon.jpg">
    <p>Frostbite Pigeon<br>HP: 2100<br>Damage: 0.62<br>80 pigeon coins</p>
    <button onclick="buy('frostbitePigeon', 80)">Buy</button>
  </div>
                         
  <div class="pigeon-card">
    <img src="gerbell.jpg">
    <p>Gooning Gerbell<br>HP: 1800<br>Damage: 0.65<br>90 pigeon coins</p>
    <button onclick="buy('gerbellPigeon', 90)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="snowypigeon.jpg">
    <p>Snowy Pigeon<br>HP: 2000<br>Damage: 0.611<br>95 pigeon coins</p>
    <button onclick="buy('snowyPigeon', 95)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="blackarmypigeon.jpg">
    <p>Black Army Pigeon<br>HP: 2440<br>100 pigeon coins</p>
    <button onclick="buy('blackarmyPigeon', 100)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="emipigeon.jpg">
    <p>Emi Pigeon<br>Deals 0.655 dmg<br>100 pigeon coins</p>
    <button onclick="buy('emiPigeon', 100)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="diamondpigeon.jpg">
    <p>Diamond Pigeon<br>Uhm, xp is 1995 and 0.62 damage ig..<br>110 pigeon coins</p>
    <button onclick="buy('diamondPigeon', 110)">Buy</button>
  </div>
      
  <div class="pigeon-card">
    <img src="lavapigeon.jpg">
    <p>Lava Pigeon<br>HP: 2500<br>Damage: 0.75<br>100 pigeon coins</p>
    <button onclick="buy('lavapigeon', 100)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="clownpigeon.jpg">
    <p>Clown Pigeon<br>+5 speed<br>+30 attack<br>130 pigeon coins</p>
    <button onclick="buy('clownPigeon', 130)">Buy</button>
  </div>

 <div class="pigeon-card">
    <img src="richpigeon.jpg">
    <p>Rich Pigeon<br>+5.5 speed<br>+35 attack<br>155 pigeon coins</p>
    <button onclick="buy('richPigeon', 155)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="twoakspigeon.jpg">
    <p>Twoaks Pigeon<br>HP: 1966<br>Damage: 0.47<br>175 pigeon coins</p>
    <button onclick="buy('twoaksPigeon', 175)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="pigobomb.jpg">
    <p>PigeonCopter<br>-1.5 HP per attack<br>180 pigeon coins</p>
    <button onclick="buy('pigeonCopter', 180)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="snowdriftpigeon.jpg">
    <p>Snowdrift Pigeon<br>+0.55 dmg, 1755 XP<br>185 pigeon coins</p>
    <button onclick="buy('snowdriftPigeon', 185)">Buy</button>
  </div>
      
  <div class="pigeon-card">
    <img src="feetphone.jpg">
    <p>Google Nexus Feet Pigeon<br>0.6 dmg<br>210 pigeon coins</p>
    <button onclick="buy('feetphone', 210)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="candypigeon.jpg">
    <p>Candy Pigeon<br>1700 HP<br>0.61 dmg<br>220 pigeon coins</p>
    <button onclick="buy('candyPigeon', 220)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="spinpigeon.jpg">
    <p>Spin Pigeon<br>0.5 dmg<br>300 pigeon coins</p>
    <button onclick="buy('spinPigeon', 300)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="tankpigeon.jpg">
    <p>Tank Pigeon<br>3200 HP<br>0.7 dmg<br>300 pigeon coins</p>
    <button onclick="buy('tankPigeon', 300)">Buy</button>
  </div>

  <div class="pigeon-card">
    <img src="wizardpigeon.jpg">
    <p>Wizard Pigeon<br>+40 attack<br>5000 pigeon coins</p>
    <button onclick="buy('wizardPigeon', 5000)">Buy</button>
  </div>

  <h2>PowerUps</h2>
  <div class="pigeon-card">
    <img src="classicpigeon.jpg">
    <p>Pigeonin Classic<br>+10 attack<br>+0.6 damage<br>300 pigeon coins</p>
    <button onclick="buyClassicPigeon()">Buy</button>
  </div>

  <h2>Promocodes</h2>
  <input id="promocodeInput" placeholder="Enter promocode here...">
  <button onclick="checkPromocode()">Apply</button>
  <div id="promoMessage"></div>

  <button onclick="closeShop()">Back</button>
</div>
   
 <div id="pigeonsMenu" style="display:none;">
    <h2>Your Pigeons</h2>
    <div id="ownedPigeons"></div>
    <button onclick="closePigeons()">Back</button>
  </div>
 <div id="communityShop" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; z-index:10000; justify-content:center; align-items:center; flex-direction:column; font-family: 'Poppins', sans-serif;">
  <h1>Secret Shop</h1>
  <p id="spgcoinDisplay">Super Pigeon Coins: 0</p>
 <!-- SELL DIALOG -->
<div id="sellDialog" class="sell-dialog" aria-hidden="true">
  <div class="sell-card" role="dialog" aria-modal="true">
    <div id="sellText">Finding a pigeon to sold to.. <span id="sellDots"><span class="sell-spinner"></span></span></div>
    <div id="sellTime" class="sell-time">Searching...</div>
  </div>
</div>

<div id="toast" style="
  visibility: hidden;
  min-width: 200px;
  margin-left: -100px;
  background-color: #333;
  color: #fff;
  text-align: center;
  border-radius: 999px;
  padding: 16px;
  position: fixed;
  z-index: 1000;
  left: 50%;
  bottom: 30px;
  font-size: 17px;
  opacity: 0;
  transition: opacity 0.5s, bottom 0.5s;
"></div>
                    
  <div class="pigeon-card">
    <img src="lawpigeon.jpg" alt="Law Pigeon">
    <p>Law Pigeon<br>cat pigeon hybrid. Yes<br>20 spgc<br>40 attack<br>2000 HP, 0.7 dmg</p>
    <button onclick="buysuper('lawPigeon', 20)">Buy</button>
  </div>
  
  <button onclick="closeCommunityShop()" style="margin-top:20px; padding:10px 20px; font-size:16px;">Back</button>
</div>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="version">PigeonBattle 0.6.3</div>
    <div id="joystick"></div>
    <div id="shootBtn">bang</div>
    <div id="superbangBtn">SUPERBANG</div>
  </div>
  
<script>
window.showBattleResult = function(type, data) {
  let overlay = document.getElementById('battleResultOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'battleResultOverlay';
    overlay.setAttribute('aria-hidden', 'true');
    overlay.style.display = 'none';
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.zIndex = '35000';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.fontFamily = "Poppins, sans-serif";
    overlay.innerHTML = `
      <div id="battleResultCard" role="dialog" aria-modal="true" style="background:linear-gradient(180deg, rgba(10,14,18,0.95), rgba(20,24,30,0.96)); border-radius:18px; padding:26px; min-width:320px; max-width:720px; box-shadow:0 18px 50px rgba(0,0,0,0.6);">
        <h1 id="battleResultTitle" style="font-size:2.4em; margin:0 0 6px 0; letter-spacing:1px;">Result</h1>
        <div class="subtext" id="battleResultSub" style="font-size:1.05em; margin-bottom:10px; opacity:.95;">Summary</div>
        <div class="rewards" id="battleResultRewards" style="margin-top:12px; font-size:1.05em; line-height:1.6;"></div>
        <div class="btn-row" style="margin-top:16px; display:flex; gap:12px; justify-content:center;">
          <button class="battle-btn primary" id="battleContinueBtn" style="padding:10px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size:1em; background:#1bd760; color:#00310a;">Continue</button>
          <button class="battle-btn secondary" id="battleToMenuBtn" style="padding:10px 18px; border-radius:12px; border:none; cursor:pointer; font-weight:700; font-size:1em; background:#2a2f38; color:#fff;">Back to Menu</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
  }

  const title = document.getElementById('battleResultTitle');
  const sub = document.getElementById('battleResultSub');
  const rewards = document.getElementById('battleResultRewards');
  const continueBtn = document.getElementById('battleContinueBtn');
  const menuBtn = document.getElementById('battleToMenuBtn');

  // clear old rewards
  rewards.innerHTML = '';

  if (type === 'win') {
    title.textContent = 'YOU WIN!';
    sub.textContent = `Well played — here's your reward:`;
    if (data && data.coinGain) rewards.innerHTML += `<span>+${data.coinGain} pigeon coins</span>`;
    if (data && data.spgcGain) rewards.innerHTML += `<span>+${data.spgcGain} SPGC</span>`;
    if (data && typeof data.rankGain !== 'undefined') rewards.innerHTML += `<span>+${data.rankGain} pigeon rank</span>`;
  } else if (type === 'lose') {
    title.textContent = 'YOU LOST!';
    sub.textContent = `Tough one — better luck next time:`;
    if (data && typeof data.rankLoss !== 'undefined') rewards.innerHTML += `<span>-${data.rankLoss} pigeon rank</span>`;
  } else {
    title.textContent = 'RESULT';
    sub.textContent = '';
  }

  // show overlay
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden', 'false');

  // button handlers
  continueBtn.onclick = function() {
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    // reload to start new battle if game running
    try { 
      if (document.getElementById('gameContainer') && document.getElementById('gameContainer').style.display === 'block') {
        location.reload();
      }
    } catch(e) { console.error(e); }
  };
  menuBtn.onclick = function() {
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    try {
      document.getElementById('gameContainer').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
      location.reload();
    } catch(e) { location.reload(); }
  };
};
</script>
<script>
 

let playerId = localStorage.getItem("playerId");

fetch("https://pigeonbattle.onrender.com/ping", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({ player_id: playerId })
})
  .then(res => res.json())  // get pigeon count
  .then(onlineCount => {
    document.getElementById("onlineStatus").innerText = "~ " + onlineCount + " pigeons online";
  })
  .catch(error => console.error('Error fetching data:', error));
  
src="https://cdn.jsdelivr.net/npm/nipplejs@0.8.0/dist/nipplejs.min.js"

const preloadLog = document.getElementById("preloadLog");

function logLine(text) {
  preloadLog.textContent += text + "\n";
}

const assets = [
  "bg.jpg",
  "pigeon.jpg",
  "wheelpigeon.jpg",
  "pigobomb.jpg",
  "feetpigeon.jpg",
  "emipigeon.jpg",
  "dentistpigeon.jpg",
  "armypigeon.jpg",
  "goonpigeon.jpg",
  "clownpigeon.jpg",
  "wizardpigeon.jpg",
  "feetphone.jpg",
  "spinpigeon.jpg",
  "spacepigeon.jpg",
  "blackarmypigeon.jpg",
  "candypigeon.jpg",
  "lawpigeon.jpg",
  "angrypigeon.jpg",
  "milkpigeon.jpg",
  "nuclearbird.jpg",
  "skinnybirb.jpg",
  "screaming.jpg",
  "kingpigeon.jpg",
  "medal.jpg",
  "twoakspigeon.jpg",
  "lavapigeon.jpg",
  "snowypigeon.jpg"
];

function preloadAssets(list, callback) {
  let loaded = 0;
  list.forEach(asset => {
    logLine("Loading JPG asset " + asset + "...");
    const img = new Image();
    img.onload = img.onerror = () => {
      loaded++;
      if (loaded === list.length) {
        callback();
      }
    };
    img.src = asset;
  });
}

preloadAssets(assets, () => {
  setTimeout(() => logLine("Checking pigeons.."), 300);
  setTimeout(() => logLine("Checking coins..."), 100);
  setTimeout(() => logLine("[CLIENT] Pinging the PB server :: POST query... 200 OK"), 100);
  setTimeout(() => logLine("Launching the game"), 150);
  setTimeout(() => {
    logLine("PigeonBattle 0.6.3 BY zntsproj");
    const splash = document.getElementById('splash');
    splash.style.opacity = '0';
    splash.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      if (splash && splash.parentNode) splash.parentNode.removeChild(splash);
      const menu = document.getElementById('menu');
      if (menu) menu.style.display = 'flex';
    }, 500);
  }, 1800);
});

    function selectPigeon(pigeon) {
      localStorage.setItem('selectedPigeon', pigeon);
      if (pigeon === 'wheel') {
        playerImg.src = 'wheelpigeon.jpg';
      } else if (pigeon === 'radio') {
        playerImg.src = 'radiopigeon.jpg';
      } else {
        playerImg.src = 'pigeon.jpg';
      }
    }


function toast(message, duration = 3000) {
  const x = document.getElementById("toast");
  x.innerText = message;
  x.style.visibility = "visible";
  x.style.opacity = "1";
  x.style.bottom = "50px";
  setTimeout(() => {
    x.style.opacity = "0";
    x.style.bottom = "30px";
    setTimeout(() => x.style.visibility = "hidden", 500);
  }, duration);
}



let pigeoninClassic = localStorage.getItem('pigeoninClassic');
const pigeoninExpiry = localStorage.getItem('pigeoninExpiry'); 

function buyClassicPigeon() {
  if (coins >= 300 && !pigeoninClassic) {
    coins -= 300
    localStorage.setItem('pigeonCoins', coins);

    pigeoninClassic = true;
    const expiryDate = new Date();
    expiryDate.setHours(expiryDate.getHours() + 24);
    localStorage.setItem('pigeoninClassic', pigeoninClassic);
    localStorage.setItem('pigeoninExpiry', expiryDate.toISOString());

    alert('Pigeonin Classic is purcashed!');

    updateCoinsDisplay();
  } else {
    alert('Already purcashed, or no money..');
  }
}

function buyNFT(nft, cost) {
  coins = parseInt(localStorage.getItem('pigeonCoins') || coins || 0, 10);

  if (coins >= cost) {
    const owned = JSON.parse(localStorage.getItem('ownedNFTs') || '[]');
    if (owned.some(x => x.id === nft.id)) {
      alert('You already own this NFT.');
      return;
    }

    coins -= cost;
    localStorage.setItem('pigeonCoins', coins);
    owned.push(nft);
    localStorage.setItem('ownedNFTs', JSON.stringify(owned));
    try { ownedNFTs = owned; } catch(e){}

    updateCoinsDisplay && updateCoinsDisplay();
    renderOwnedNFTs && renderOwnedNFTs();

    try {
      if (typeof updateSpentCoins === 'function') updateSpentCoins(cost);
    } catch(e){}

    toast && toast(`${nft.name} purchased! -${cost} coins`);
  } else {
    alert('Not enough coins to buy this NFT.');
  }
}

function selectNFT(id) {
  const nft = ownedNFTs.find(n => n.id === id);
  if (nft) {
    selectedNFT = id;
    localStorage.setItem('selectedNFT', selectedNFT);
    alert(`${nft.name} is now active!`);
  }
}

function isClassicPigeonActive() {
  if (pigeoninClassic) {
    const now = new Date();
    const expiryDate = new Date(pigeoninExpiry);
    if (now < expiryDate) {
      return true;
    } else {
                localStorage.removeItem('pigeoninClassic');
      localStorage.removeItem('pigeoninExpiry');
      return false;
    }
  }
  return false;
}

    const canvas = document.getElementById('gameCanvas');
    
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 600;

    const coinsDisplay = document.getElementById('coinsDisplay');
    let coins = parseInt(localStorage.getItem('pigeonCoins') || '0');
let pigeonRank = parseInt(localStorage.getItem("pigeonRank") || "0");

function updatePigeonRankDisplay() {
  const el = document.getElementById("pigeonRankDisplay");
  el.textContent = "PigeonRank: " + pigeonRank;

  if (pigeonRank < 100) el.style.color = "gray";
  else if (pigeonRank < 500) el.style.color = "yellow";
  else if (pigeonRank < 1000) el.style.color = "deepskyblue";
  else if (pigeonRank < 5000) el.style.color = "red";
  else if (pigeonRank < 20000) el.style.color = "violet";
  else if (pigeonRank < 100000) {
    el.style.color = "gold";
    el.style.textShadow = "1px 1px 2px black";
  } else {
    el.style.background = "linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)";
    el.style.webkitBackgroundClip = "text";
    el.style.webkitTextFillColor = "transparent";
    el.style.fontWeight = "900";
  }
}
updatePigeonRankDisplay();

function checkPigeonRankMilestones() {
  const milestone1000 = localStorage.getItem("pigeonRank1000Rewarded");
  if (pigeonRank >= 1000 && !milestone1000) {
    coins += 100;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank1000Rewarded", "true");
    alert("You have 1000 PIGEON RANK NOW! You was helping us, pigeons. Here's your 100 Coins. You deserve it!");
    updateCoinsDisplay();
  }
}


function checkExtraMilestones(){
  if(pigeonRank >= 10000 && !localStorage.getItem("pigeonRank10000Rewarded")){
    coins += 150;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank10000Rewarded","true");
    alert("Well.. You played too much pigeon battle.\nHere's your 150 coins!");
    updateCoinsDisplay();
  }
  if(pigeonRank >= 100000 && !localStorage.getItem("pigeonRank100000Rewarded")){
    localStorage.setItem("pigeonRank100000Rewarded","true");
    const toastEl = document.createElement('div');
    toastEl.style.position = 'fixed';
    toastEl.style.top = '-100px';
    toastEl.style.left = '50%';
    toastEl.style.transform = 'translateX(-50%)';
    toastEl.style.background = '#222';
    toastEl.style.color = '#fff';
    toastEl.style.borderRadius = '20px';
    toastEl.style.padding = '12px 20px';
    toastEl.style.fontFamily = 'Poppins, sans-serif';
    toastEl.style.textAlign = 'center';
    toastEl.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
    toastEl.innerHTML = "<div style='color:yellow;font-weight:700'>New milestone achieved!</div><div style='color:gray'>Played too much pigeon battle...</div>";
    document.body.appendChild(toastEl);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease'; toastEl.style.top='30px';},100);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease, opacity 0.5s ease'; toastEl.style.top='-100px'; toastEl.style.opacity='0';},4000);
    setTimeout(()=>toastEl.remove(),5000);
  }
  if(pigeonRank >= 1000000){
    const el = document.getElementById("pigeonRankDisplay");
    el.style.color = "#b900ff";
    el.style.textShadow = "0 0 8px #ff00ff";
    el.style.fontWeight = "bold";
  }
}

checkPigeonRankMilestones();
checkExtraMilestones();
    const owned = JSON.parse(localStorage.getItem('ownedPigeons') || '["default"]');
    let selected = localStorage.getItem('selectedPigeon') || 'default';
    // nfts
    let ownedNFTs = JSON.parse(localStorage.getItem('ownedNFTs') || '[]');
    let selectedNFT = localStorage.getItem('selectedNFT') || null;


if (!playerId) {
  fetch("https://pigeonbattle.onrender.com/multiplayerPing?player_id=")
    .then(res => res.json())
    .then(data => {
      playerId = data.player_id;
      localStorage.setItem("playerId", playerId);
    });
}

function updateSpentCoins(amount) {
  fetch("https://pigeonbattle.onrender.com/updateSpentCoins", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    player_id: playerId,
    amount
  })
})
  .then(res => res.json())
  .then(data => console.log("Spent coins updated:", data))
  .catch(err => console.error("Failed to update coins:", err));
}

const CASE_COOLDOWN_MS = 90 * 60 * 1000; // 1.5 hrs
function getCaseCooldownLeft() {
  const last = parseInt(localStorage.getItem('caseLastOpen') || '0', 10);
  const now = Date.now();
  const left = CASE_COOLDOWN_MS - (now - last);
  return Math.max(0, left);
}
function formatLeft(ms) {
  const totalSec = Math.ceil(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  const hh = h > 0 ? `${h}h ` : '';
  const mm = m > 0 ? `${m}m ` : '';
  const ss = `${s}s`;
  return `${hh}${mm}${ss}`.trim();
}
function updateCaseStatus() {
  const el = document.getElementById('caseStatus');
  const btn = Array.from(document.querySelectorAll('#shop .pigeon-card button'))
    .find(b => b.getAttribute('onclick') === 'openCase()');
  if (!el || !btn) return;

  const left = getCaseCooldownLeft();
  if (left > 0) {
    el.textContent = `Case on cooldown: ${formatLeft(left)} left`;
    btn.disabled = true;
    btn.textContent = 'Cooldown...';
  } else {
    el.textContent = 'Case is ready!';
    btn.disabled = false;
    btn.textContent = 'Buy';
  }
}
setInterval(updateCaseStatus, 1000);
document.addEventListener('DOMContentLoaded', updateCaseStatus);


function showCaseResult(type, data) {
  const overlay = document.getElementById("caseResultOverlay");
  const title = document.getElementById("caseResultTitle");
  const img = document.getElementById("caseResultImg");
  const text = document.getElementById("caseResultText");

  if (type === "coins") {
    title.textContent = "Coins!";
    text.textContent = `+${data}`;
    img.style.display = "none";
  } else if (type === "pigeon") {
    title.textContent = "New Pigeon!!!";
    text.textContent = data.name;
    img.src = data.img;
    img.style.display = "block";
  }
  overlay.style.display = "flex";
}

function closeCaseResult() {
  document.getElementById("caseResultOverlay").style.display = "none";
}

function openCase() {
  const left = getCaseCooldownLeft();
  if (left > 0) {
    alert(`Case is still on cooldown: ${formatLeft(left)} remain.`);
    updateCaseStatus();
    return;
  }
  if (coins < 70) {
    alert("Not enough coins to open the case!");
    return;
  }

  coins -= 70;
  localStorage.setItem('caseLastOpen', Date.now().toString());
  let chance = Math.random() * 100;

  if (chance <= 75) {
    let coinAmount = Math.floor(Math.random() * 140) + 10;
    coins += coinAmount;
    updateSpentCoins(70);
    localStorage.setItem('pigeonCoins', coins);
    updateCoinsDisplay();
    updateCaseStatus();
    showCaseResult("coins", coinAmount);
  } else {
    const pigeonIds = Object.keys(pigeons);
    let pigeonId = pigeonIds[Math.floor(Math.random() * pigeonIds.length)];
    let pigeonsStorage = JSON.parse(localStorage.getItem('ownedPigeons')) || [];

    if (!pigeonsStorage.includes(pigeonId)) {
      pigeonsStorage.push(pigeonId);
      localStorage.setItem('ownedPigeons', JSON.stringify(pigeonsStorage));
      updateSpentCoins(70);
      localStorage.setItem('pigeonCoins', coins);
      updateCoinsDisplay();
      updateCaseStatus();
      showCaseResult("pigeon", { name: pigeonId, img: pigeons[pigeonId].img });
    } else {
      alert(`You already have this pigeon: ${pigeonId}. Try again!`);
    }
  }
}


let superPigeonCoins = parseInt(localStorage.getItem("spgcoins")) || 0;

function comp() {
  if (!localStorage.getItem('compReceived')) {
    coins += 450;
    localStorage.setItem('pigeonCoins', coins);
    localStorage.setItem('compReceived', 'true');
    updateCoinsDisplay();
    alert("450 pigeon coins added. A pigeon’s gonna eat, you know? Ruby if u reading ts im gonna finger you");
  } else {
    alert("No double-dipping! The pigeon already got its snack.");
  }
}

const pigeons = {
  lavapigeon: { img: 'lavapigeon.jpg', speed: 5, attack: 20, damage: 0.75, hp: 2500, shootType: 'normal_shoot' },
  candyPigeon: { img: 'candypigeon.jpg', speed: 5.5, attack: 25, damage: 0.6, hp: 1700, shootType: 'candy_shoot' },
  spinPigeon: { img: 'spinpigeon.jpg', speed: 4, attack: 20, damage: 1.2, hp: 1500, shootType: 'spin_shoot' },
  default: { img: 'pigeon.jpg', speed: 5, attack: 10, damage: 0.35, hp: 1200, shootType: 'normal_shoot' },
  wheelPigeon: { img: 'wheelpigeon.jpg', speed: 7, attack: 2, damage: 0.6, hp: 1000, shootType: 'normal_shoot' },
  pigeonCopter: { img: 'pigobomb.jpg', speed: 6, attack: 20, damage: 0.5, hp: 1330, shootType: 'normal_shoot' },
  feetPigeon: { img: 'feetpigeon.jpg', speed: 5, attack: 6, damage: 0.45, kick: true, hp: 1500, shootType: 'normal_shoot' },
  emiPigeon: { img: 'emipigeon.jpg', speed: 5, attack: 8, damage: 0.322, hp: 1200, shootType: 'emishoot' },
  dentistPigeon: { img: 'dentistpigeon.jpg', speed: 5, attack: 10, damage: 0.3, hp: 2000, shootType: 'normal_shoot' },
  armyPigeon: { img: 'armypigeon.jpg', speed: 5, attack: 12, damage: 0.2, hp: 1300, shootType: 'green_short' },
  sorrelPigeon: { img: 'sorrelpigeon.jpg', speed: 6.5, attack: 16, damage: 0.4, hp: 1500, shootType: 'green_short' },
  goonPigeon: { img: 'goonpigeon.jpg', speed: 4.5, attack: 13, damage: 0.5, hp: 1250, shootType: 'white_shoot', humanLegs: true, confusionAura: true },
  clownPigeon: { img: 'clownpigeon.jpg', speed: 3.8, attack: 30, damage: 0.5, hp: 1450, shootType: 'ball_shoot'},
  wizardPigeon: { img: 'wizardpigeon.jpg', speed: 7.5, attack: 40, damage: 0.805, hp: 2200, shootType: 'fireball_shoot'},
  lawPigeon: { img: 'lawpigeon.jpg', speed: 4, attack: 40, damage: 0.6254, hp: 1600},
  feetphone: { img: 'feetphone.jpg', speed: 6, attack: 20, damage: 0.55, hp: 2200, shootType: 'normal_shoot' },
  spacePigeon: { img: 'spacepigeon.jpg', speed: 4, attack: 50, damage: 0.409, hp: 1875, shootType: 'purple_shoot' },
  blackarmyPigeon: { img: 'blackarmypigeon.jpg', speed: 5, attack: 25, damage: 0.506, hp: 2440, shootType: 'normal_shoot' },
  twoaksPigeon: { img: 'twoakspigeon.jpg', speed: 5, attack: 12, damage: 0.7, hp: 1966, shootType: 'twoaks_shoot' },
  tankPigeon: { img: 'tankpigeon.jpg', speed: 2.1, attack: 5, damage: 0.7, hp: 3200, shootType: 'green_short' },
  hippoPigeon: { img: 'hipposigeon.jpg', speed: 5.5, attack: 10, damage: 0.57, hp: 2110, shootType: 'normal_shoot' },
  snowyPigeon: { img: 'snowypigeon.jpg', speed: 5.2, attack: 25, damage: 0.611, hp: 2000, shootType: 'normal_shoot', snowy: true },
  richPigeon: { img: 'richpigeon.jpg', speed: 5.5, attack: 35, damage: 0.627, hp: 2560, shootType: 'golden_rain' }, // HAHHAHAAH
  frostbitePigeon: {
  img: 'frostbitepigeon.jpg',
  speed: 5.1,
  attack: 25,
  damage: 0.62,
  hp: 2100,
  shootType: 'ice_shoot',
  snowy: true },
  snowdriftPigeon: { img: 'snowdriftpigeon.jpg', speed: 4.5, attack: 30, damage: 0.55, hp: 1755, shootType: 'normal_shoot' },
  gerbellPigeon: { img: 'gerbell.jpg', speed: 5.5, attack: 40, damage: 0.65, hp: 1800, shootType: 'normal_shoot' },
  diamondPigeon: { img: 'diamondpigeon.jpg', speed: 6, attack: 35, damage: 0.62, hp: 1995, shootType: 'normal_shoot' },
};

   const enemies = [
  { img: 'angrypigeon.jpg', hp: 2200, speed: 2, attack: 40 },
  { img: 'milkpigeon.jpg', hp: 1800, speed: 3, attack: 30 },
  { img: 'nuclearbird.jpg', hp: 3000, speed: 1.5, attack: 60 },
  { img: 'skinnybirb.jpg', hp: 1000, speed: 4, attack: 20 },
  { img: 'screaming.jpg', hp: 1500, speed: 2, attack: 50}
];

const bossForm = {
  img: 'kingpigeon.jpg',
  hp: 1400,
  speed: 2,
  attack: 60
};

let bossTransformed = false;
let bossFlashCounter = 0;

const player = { x: 100, y: 250, w: 64, h: 64, hp: pigeons[selected].hp };

const bots = [
  { img: 'angrypigeon.jpg',    hp: 2200, speed: 2,   attack: 40, damage: 120 },
  { img: 'milkpigeon.jpg',     hp: 1800, speed: 3,   attack: 50, damage: 180 },
  { img: 'skinnybirb.jpg',     hp: 3000, speed: 1.5, attack: 35, damage: 90 },
  { img: 'nuclearbird.jpg',    hp: 2400, speed: 2,   attack: 40, damage: 250 },
  { img: 'screaming.jpg',      hp: 1300, speed: 1,   attack: 20, damage: 70 },
  { img: 'oldpigeon.jpg',      hp: 2900, speed: 0.9, attack: 15, damage: 55 },
  { img: 'sbbrother.jpg',      hp: 2400, speed: 4,   attack: 13, damage: 450 },
  { img: 'spacegooner.jpg',     hp: 2300, speed: 3.2, attack: 20, damage:500 },
  { img: 'evilsorrel.jpg',     hp: 1450, speed: 2.5, attack: 13, damage:450 }
];

// random enemy
const chosenBot = bots[Math.floor(Math.random() * bots.length)];
const bot = { x: 600, y: 250, w: 64, h: 64, ...chosenBot };

const bullets = [], botBullets = [], keys = {};
let spinMode = false;
let spinTimer = 0;
let spinCooldown = Math.floor(Math.random() * 180) + 60; 

let gameStarted = false;
// === FPS measurement ===
let _lastFrameTime = performance.now();
let _fps = 0; // smoothed true FPS
const _fpsAlpha = 0.85; // smoothing (0..1), lower = more responsive


const emiUlt = {
  available: true,
  active: false,
  duration: 5000,
  cooldown: 40000,
  radius: 140, // pixels
  damagePerSecond: 30,
  startedAt: 0,
  cooldownStartedAt: 0
};

const spaceUlt = {
  available: true,
  active: false,
  duration: 5000,
  cooldown: 40000,
  startedAt: 0,
  cooldownStartedAt: 0,
  blades: [], // will be filled on activation
  orbitRadius: 90, // distance from player center to blade center
  bladeSize: 34, // visual triangle size
  bladeHitRadius: 30, // collision check radius
  damage: 200
};


const lavaUlt = {
  available: true,
  active: false,
  duration: 1200,        // short active time (ms) for flash/shake
  cooldown: 40000,       // 40 seconds cooldown
  startedAt: 0,
  cooldownStartedAt: 0,
  damage: 400
};

const frostUlt = {
  available: true,
  active: false,
  duration: 2000,
  cooldown: 40000,
  startedAt: 0,
  cooldownStartedAt: 0
};


const playerImg = new Image();
playerImg.src = pigeons[selected].img;
const botImg = new Image();
botImg.src = bot.img;

    document.getElementById('playButton').onclick = () => {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'block';
      gameStarted = true;
      draw();
    };
  
    document.getElementById('shopButton').onclick = () => {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('shop').style.display = 'flex';
    };

 document.getElementById('pigeonsButton').onclick = () => {
      document.getElementById('menu').style.display = 'none';
      
document.getElementById('pigeonsMenu').style.display = 'flex';
      const container = document.getElementById('ownedPigeons');
      container.innerHTML = '';
      owned.forEach(id => {
  const p = pigeons[id];
  if (!p) return; // no pigeon then skip
  const div = document.createElement('div');
  div.className = 'pigeon-card';
  div.innerHTML = `<img src="${p.img}" /><p>${id}</p><button onclick="selectPigeon('${id}')">Select</button>`;
  container.appendChild(div);
});
    };
    function selectPigeon(id) {
      selected = id;
      localStorage.setItem('selectedPigeon', id);
      alert(id + ' selected!');
    }

    function closeShop() {
      document.getElementById('shop').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
      updateCoinsDisplay();
    }

    function closePigeons() {
     
 document.getElementById('pigeonsMenu').style.display = 'none';
      document.getElementById('menu').style.display = 'flex';
    }

function showAchievement(text) {
  const ach = document.getElementById('achievement');
  ach.textContent = text;
  ach.classList.add('show');
  setTimeout(() => {
    ach.classList.remove('show');
  }, 3000);
}


    function buy(id, cost) {
      if (!owned.includes(id) && coins >= cost) {
        coins -= cost;
        owned.push(id);
        localStorage.setItem('pigeonCoins', coins);
        localStorage.setItem('ownedPigeons', JSON.stringify(owned));
        alert(id + ' bought!');
        updateSpentCoins(cost);
        showAchievement("You have got a new pigeon!");
        } else {
        alert('Not enough coins or already owned');
      }
      updateCoinsDisplay();
    }
    
    function buysuper(id, cost) {
      if (!owned.includes(id) && superPigeonCoins >= cost) {
        superPigeonCoins -= cost;
        owned.push(id);
        localStorage.setItem('spgcoins', coins);
        localStorage.setItem('ownedPigeons', JSON.stringify(owned));
        alert(id + ' bought!');
        } else {
        alert('Not enough coins or already owned');
      }
    }
    
    
function shootCandy(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 12,
    h: 12,
    speed: 10,
    dmg: 5 * dmgBoost,
    color: 'candy'
  });
}

function shootWhite(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 10,
    h: 10,
    speed: 10,
    dmg: 1,
    color: 'white'
  });
}
   
   function shootBall(player, balls, dmgBoost) {
  balls.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 10,
    h: 10,
    speed: 10,
    dmg: 1 * dmgBoost,
    color: 'red'
  });
}

    function shootEmi(from, bullets, dmg = 0.655, speed = 10) {
  bullets.push({
    x: from.x + from.w,
    y: from.y + from.h / 2 - 5,
    w: 10,  // weight
    h: 50,  // height
    speed: from === player ? speed : -speed,
    dmg: dmg,
    color: 'blue' // color
  });
}

function shootGreen(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 15,
    h: 5,
    speed: 12,
    dmg: 1,
    color: 'green'
  });
}
              
function shootGolden(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 15,
    h: 5,
    speed: 12,
    dmg: 1,
    color: 'yellow'
  });
}

function shootPurple(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 5,
    w: 10,
    h: 10,
    speed: 10,
    dmg: 5 * dmgBoost,
    color: 'purple'
  });
}
   
function shootTwoaks(player, bullets, dmgBoost) {
  const leftX = player.x;
  const rightX = player.x + player.w;
  const y = player.y + player.h / 2 - 3;
  const speed = 14;
  bullets.push({ x: leftX, y: y, w: 4, h: 2, speed: -speed, dmg: dmgBoost, color: 'black' });
  bullets.push({ x: rightX, y: y, w: 4, h: 2, speed: speed, dmg: dmgBoost, color: 'black' });
}

function shootFireball(player, bullets, dmgBoost) {



  const originX = player.x + player.w / 2;
  const originY = player.y + player.h / 2;
  const speed = 12;

  let velX = speed;
  let velY = 0;

  if (bot && typeof bot.x !== "undefined") {
    const targetX = bot.x + bot.w / 2;
    const targetY = bot.y + bot.h / 2;
    const angle = Math.atan2(targetY - originY, targetX - originX);
    velX = Math.cos(angle) * speed;
    velY = Math.sin(angle) * speed;
  }

  bullets.push({
    x: originX,
    y: originY,
    w: 15,
    h: 15,
    speedX: velX,
    speedY: velY,
    dmg: 2 * dmgBoost,
    color: 'orange'
  });
}

function shootIce(player, bullets, dmgBoost) {
  bullets.push({
    x: player.x + player.w,
    y: player.y + player.h / 2 - 8,
    w: 14,
    h: 14,
    speed: 11,
    dmg: 6 * dmgBoost,
    color: 'ice'
  });
}

function checkPromocode() {
  const input = document.getElementById('promocodeInput').value.trim();
  const msg = document.getElementById('promoMessage');

  // 1. Промокод siscorddex (старый)
  if (input === "siscorddex") {
    if (!localStorage.getItem("promo_siscorddex_used")) {
      let coinsLocal = parseInt(localStorage.getItem('pigeonCoins') || '0', 10);
      coinsLocal += 111;
      localStorage.setItem('pigeonCoins', coinsLocal);
      localStorage.setItem("promo_siscorddex_used", "true");

      coins = coinsLocal;
      msg.style.color = "lime";
      msg.textContent = "Promocode accepted! +111 coins added 💸";
      updateCoinsDisplay();
    } else {
      msg.style.color = "gray";
      msg.textContent = "This promocode was already used!";
    }
  } 

  // 2. НОВЫЙ: pigeoning9311 (60 коинов)
  else if (input === "pigeoning9311") {
    if (!localStorage.getItem("promo_pigeoning_used")) {
      let coinsLocal = parseInt(localStorage.getItem('pigeonCoins') || '0', 10);
      coinsLocal += 60;
      localStorage.setItem('pigeonCoins', coinsLocal);
      localStorage.setItem("promo_pigeoning_used", "true");

      coins = coinsLocal;
      msg.style.color = "lime";
      msg.textContent = "+60 coins added!";
      updateCoinsDisplay();
    } else {
      msg.style.color = "gray";
      msg.textContent = "Already used!";
    }
  }

  else if (input === "88FatSigeon88") {
    if (!localStorage.getItem("promo_fatsigeon_used")) {
      if (!owned.includes("goonPigeon")) {
        owned.push("goonPigeon"); 
        localStorage.setItem('ownedPigeons', JSON.stringify(owned));
        localStorage.setItem("promo_fatsigeon_used", "true");

        msg.style.color = "gold";
        msg.textContent = "Goon Pigeon joined you! 🥚";
        showAchievement("You have got a new pigeon!");
      } else {
        msg.style.color = "gray";
        msg.textContent = "You already have this pigeon!";
      }
    } else {
      msg.style.color = "gray";
      msg.textContent = "Promocode expired for you!";
    }
  }

  else {
    msg.style.color = "red";
    msg.textContent = "Incorrect promocode! Try again, scrub.";
  }
}



function updateCoinsDisplay() {
      coinsDisplay.textContent = 'Coins: ' + coins;
    }

    document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    canvas.addEventListener('mousedown', () => {
  keys[' '] = true;
});
canvas.addEventListener('mouseup', () => {
  keys[' '] = false;
});

    
function shoot360(player, bullets, dmg = 10, speed = 5, color = 'purple') {
  for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 8) { // 16 пуль
    bullets.push({
      x: player.x + player.w / 2,
      y: player.y + player.h / 2,
      w: 8,
      h: 8,
      speedX: Math.cos(angle) * speed,
      speedY: Math.sin(angle) * speed,
      dmg: dmg,
      color: color
    });
  }
}

function shoot(from, list, dmg = 10, speed = 5) {
      list.push({ 
        x: from.x + (from === player ? from.w : -10), 
        y: from.y + from.h / 2 - 5, 
        w: 10, 
        h: 10, 
        speed: from === player ? speed : -speed, 
        dmg 
      });
    }

    setInterval(() => {
      if (gameStarted) {
        shoot(bot, botBullets, Math.floor(Math.random() * 16) + 15);
        if (pigeons[selected].radiation) bot.hp -= 5;
      }
    }, 1000);

let gameOver = false;

function checkGameEnd() {
  if (gameOver) return;

  if (bot.hp <= 0) {
    gameOver = true;
    coins += 10;
    superPigeonCoins += 1;
    localStorage.setItem('spgcoins', superPigeonCoins);
    localStorage.setItem('pigeonCoins', coins);
    let gain;
    if (pigeonRank < 500) {
  gain = Math.floor(Math.random() * (15 - 5 + 1)) + 5;
} else if (pigeonRank < 1000) {
  gain = Math.floor(Math.random() * (30 - 20 + 1)) + 20;
} else if (pigeonRank < 10000) {
  gain = Math.floor(Math.random() * (85 - 50 + 1)) + 50;
} else if (pigeonRank < 50000) {
  gain = Math.floor(Math.random() * (150 - 90 + 1)) + 90;
} else {
  gain = Math.floor(Math.random() * (250 - 120 + 1)) + 120;
}

    pigeonRank += gain;
    localStorage.setItem("pigeonRank", pigeonRank);
    updatePigeonRankDisplay();

    localStorage.setItem("spgcoins", superPigeonCoins);
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank", pigeonRank);
    updatePigeonRankDisplay();

function checkPigeonRankMilestones() {
  const milestone1000 = localStorage.getItem("pigeonRank1000Rewarded");
  if (pigeonRank >= 1000 && !milestone1000) {
    coins += 100;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank1000Rewarded", "true");
    alert("You have 1000 PIGEON RANK NOW! You was helping us, pigeons. Here's your 100 Coins. You deserve it!");
    updateCoinsDisplay();
  }
}


function checkExtraMilestones(){
  if(pigeonRank >= 10000 && !localStorage.getItem("pigeonRank10000Rewarded")){
    coins += 150;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank10000Rewarded","true");
    alert("Well.. You played too much pigeon battle.\nHere's your 150 coins!");
    updateCoinsDisplay();
  }
  if(pigeonRank >= 100000 && !localStorage.getItem("pigeonRank100000Rewarded")){
    localStorage.setItem("pigeonRank100000Rewarded","true");
    const toastEl = document.createElement('div');
    toastEl.style.position = 'fixed';
    toastEl.style.top = '-100px';
    toastEl.style.left = '50%';
    toastEl.style.transform = 'translateX(-50%)';
    toastEl.style.background = '#222';
    toastEl.style.color = '#fff';
    toastEl.style.borderRadius = '20px';
    toastEl.style.padding = '12px 20px';
    toastEl.style.fontFamily = 'Poppins, sans-serif';
    toastEl.style.textAlign = 'center';
    toastEl.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
    toastEl.innerHTML = "<div style='color:yellow;font-weight:700'>New milestone achieved!</div><div style='color:gray'>Played too much pigeon battle...</div>";
    document.body.appendChild(toastEl);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease'; toastEl.style.top='30px';},100);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease, opacity 0.5s ease'; toastEl.style.top='-100px'; toastEl.style.opacity='0';},4000);
    setTimeout(()=>toastEl.remove(),5000);
  }
  if(pigeonRank >= 1000000){
    const el = document.getElementById("pigeonRankDisplay");
    el.style.color = "#b900ff";
    el.style.textShadow = "0 0 8px #ff00ff";
    el.style.fontWeight = "bold";
  }
}

checkPigeonRankMilestones();
checkExtraMilestones();

    showBattleResult('win', {coinGain: 10, spgcGain: 1, rankGain: gain});
  }

  if (player.hp <= 0) {
  gameOver = true;
  let loss;
  if(pigeonRank >= 1000000){
    loss = Math.floor(Math.random() * 45000) + 2000; // 1000 - 8000
  } else if(pigeonRank >= 100000){
    loss = Math.floor(Math.random() * 1000) + 500; // 500 - 1500
  } else if(pigeonRank >= 10000){
    loss = Math.floor(Math.random() * 400) + 100; // 100 - 500
  } else if(pigeonRank >= 1000){
    loss = Math.floor(Math.random() * 100) + 25; // 25 - 125
  } else {
    loss = Math.floor(Math.random() * 20) + 5; // 5 - 25
  }
  pigeonRank = Math.max(0, pigeonRank - loss);
  localStorage.setItem("pigeonRank", pigeonRank);
  updatePigeonRankDisplay();
  
function checkPigeonRankMilestones() {
  const milestone1000 = localStorage.getItem("pigeonRank1000Rewarded");
  if (pigeonRank >= 1000 && !milestone1000) {
    coins += 100;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank1000Rewarded", "true");
    alert("You have 1000 PIGEON RANK NOW! You was helping us, pigeons. Here's your 100 Coins. You deserve it!");
    updateCoinsDisplay();
  }
}


function checkExtraMilestones(){
  if(pigeonRank >= 10000 && !localStorage.getItem("pigeonRank10000Rewarded")){
    coins += 150;
    localStorage.setItem("pigeonCoins", coins);
    localStorage.setItem("pigeonRank10000Rewarded","true");
    alert("Well.. You played too much pigeon battle.\nHere's your 150 coins!");
    updateCoinsDisplay();
  }
  if(pigeonRank >= 100000 && !localStorage.getItem("pigeonRank100000Rewarded")){
    localStorage.setItem("pigeonRank100000Rewarded","true");
    const toastEl = document.createElement('div');
    toastEl.style.position = 'fixed';
    toastEl.style.top = '-100px';
    toastEl.style.left = '50%';
    toastEl.style.transform = 'translateX(-50%)';
    toastEl.style.background = '#222';
    toastEl.style.color = '#fff';
    toastEl.style.borderRadius = '20px';
    toastEl.style.padding = '12px 20px';
    toastEl.style.fontFamily = 'Poppins, sans-serif';
    toastEl.style.textAlign = 'center';
    toastEl.style.boxShadow = '0 6px 20px rgba(0,0,0,0.4)';
    toastEl.innerHTML = "<div style='color:yellow;font-weight:700'>New milestone achieved!</div><div style='color:gray'>Played too much pigeon battle...</div>";
    document.body.appendChild(toastEl);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease'; toastEl.style.top='30px';},100);
    setTimeout(()=>{toastEl.style.transition='top 0.5s ease, opacity 0.5s ease'; toastEl.style.top='-100px'; toastEl.style.opacity='0';},4000);
    setTimeout(()=>toastEl.remove(),5000);
  }
  if(pigeonRank >= 1000000){
    const el = document.getElementById("pigeonRankDisplay");
    el.style.color = "#b900ff";
    el.style.textShadow = "0 0 8px #ff00ff";
    el.style.fontWeight = "bold";
  }
}

checkPigeonRankMilestones();
checkExtraMilestones();

    showBattleResult('lose', {rankLoss: loss});
  }
}

/* === EMI ULT LOGIC === */
function canUseEmiUlt() {
  return selected === 'emiPigeon' && gameStarted && emiUlt.available && !emiUlt.active;
}

function startEmiUlt() {
  if (!canUseEmiUlt()) {
    // silent fail or toast
    if (selected !== 'emiPigeon') toast('Только у Эми есть супербэнг, чел');
    return;
  }
  emiUlt.active = true;
  emiUlt.available = false;
  emiUlt.startedAt = Date.now();
  // auto stop after duration
  setTimeout(() => {
    emiUlt.active = false;
    emiUlt.cooldownStartedAt = Date.now();
    // cooldown timer end
    setTimeout(() => {
      emiUlt.available = true;
    }, emiUlt.cooldown);
  }, emiUlt.duration);
  toast('SUPERBANG! Беги прятаться, враги горят 🔥', 1800);
}

/* === SPACE PIGEON ULT LOGIC === */
function canUseSpaceUlt() {
  return selected === 'spacePigeon' && gameStarted && spaceUlt.available && !spaceUlt.active;
}

function startSpaceUlt() {
  if (!canUseSpaceUlt()) {
    if (selected !== 'spacePigeon') toast('Это ульта только для Space Pigeon 💫');
    return;
  }
  spaceUlt.active = true;
  spaceUlt.available = false;
  spaceUlt.startedAt = Date.now();
  // init 3 blades with angles evenly spaced
  spaceUlt.blades = [];
  for (let i = 0; i < 3; i++) {
    spaceUlt.blades.push({
      angle: (Math.PI * 2 / 3) * i,
      speed: 0.1 + Math.random() * 0.08, // rotate speed
      hit: false // whether this blade already hit the bot in this ult
    });
  }
  // stop after duration
  setTimeout(() => {
    spaceUlt.active = false;
    spaceUlt.cooldownStartedAt = Date.now();
    setTimeout(() => {
      spaceUlt.available = true;
    }, spaceUlt.cooldown);
  }, spaceUlt.duration);

  toast('SPACE ULT: Лезвия активированы! 🟣', 1800);
}

/* Unified superbang starter used by button + key */

/* === LAVA PIGEON ULT === */
function canUseLavaUlt() {
  return selected === 'lavapigeon' && gameStarted && lavaUlt.available && !lavaUlt.active;
}

function startLavaUlt() {
  if (!canUseLavaUlt()) {
    if (selected !== 'lavapigeon') toast('Это ульта только для Lava Pigeon 🔥');
    return;
  }
  lavaUlt.active = true;
  lavaUlt.available = false;
  lavaUlt.startedAt = Date.now();

  // visual flash overlay
  let flash = document.getElementById('lavaFlashOverlay');
  if (!flash) {
    flash = document.createElement('div');
    flash.id = 'lavaFlashOverlay';
    flash.style.position = 'fixed';
    flash.style.inset = '0';
    flash.style.pointerEvents = 'none';
    flash.style.background = 'radial-gradient(circle at 50% 40%, rgba(255,220,120,0.95), rgba(255,120,40,0.0) 40%)';
    flash.style.opacity = '0';
    flash.style.transition = 'opacity 0.8s ease-out';
    flash.style.zIndex = '99999';
    document.body.appendChild(flash);
  }

  // Shake container
  const container = document.getElementById('gameContainer') || document.getElementById('canvas') || document.body;
  const origTransform = container.style.transform || '';
  let shakeStart = Date.now();
  const shakeDuration = lavaUlt.duration;

  // apply damage instantly (as requested ~400 hp)
  try {
    if (bot && typeof bot.hp === 'number') {
      bot.hp = Math.max(0, bot.hp - lavaUlt.damage);
      toast('-400 HP to enemy! 🔥', 1200);
      checkGameEnd();
    }
  } catch(e) { console.error(e); }

  // animate: quick intense flash and shake, then slowly fade
  flash.style.opacity = '1';
  // quick micro-shakes
  const shakeInterval = setInterval(() => {
    const t = Date.now() - shakeStart;
    if (t > shakeDuration) {
      clearInterval(shakeInterval);
      container.style.transform = origTransform;
      flash.style.opacity = '0';
      lavaUlt.active = false;
      lavaUlt.cooldownStartedAt = Date.now();
      setTimeout(() => { lavaUlt.available = true; }, lavaUlt.cooldown);
      return;
    }
    const intensity = 6 * (1 - t / shakeDuration); // px
    const rx = (Math.random() - 0.5) * intensity;
    const ry = (Math.random() - 0.5) * intensity;
    const rot = (Math.random() - 0.5) * (intensity * 0.2);
    container.style.transform = `translate(${rx}px, ${ry}px) rotate(${rot}deg)`;
  }, 16);

  setTimeout(() => {
    // ensure it ends
    flash.style.opacity = '0';
  }, lavaUlt.duration + 100);
}

/* === FROSTBITE PIGEON ULT === */
function canUseFrostUlt() {
  return selected === 'frostbitePigeon' && gameStarted && frostUlt.available && !frostUlt.active;
}

function startFrostUlt() {
  if (!canUseFrostUlt()) {
    if (selected !== 'frostbitePigeon') toast('Это ульта только для Frostbite Pigeon ❄️');
    return;
  }

  frostUlt.active = true;
  frostUlt.available = false;
  frostUlt.startedAt = Date.now();

  // freeze enemy
  bot.freezeUntil = Date.now() + frostUlt.duration;

  // frost vignette
  canvas.style.boxShadow = "inset 0 0 120px rgba(150,200,255,0.85)";
  document.body.style.filter = "brightness(0.9)";

  // stop ult after duration
  setTimeout(() => {
    frostUlt.active = false;
    canvas.style.boxShadow = "";
    document.body.style.filter = "";

    frostUlt.cooldownStartedAt = Date.now();
    setTimeout(() => {
      frostUlt.available = true;
    }, frostUlt.cooldown);

  }, frostUlt.duration);

}

function startSuperbang() {
  if (selected === 'emiPigeon') {
    startEmiUlt();
  } else if (selected === 'spacePigeon') {
    startSpaceUlt();
  } else if (selected === 'lavapigeon') {
    startLavaUlt();
  } else if (selected === 'frostbitePigeon') {
    startFrostUlt();
  } else {
    toast('No superpower');
  }
}


/* Hook superbang button events */
const superbangBtn = document.getElementById('superbangBtn');
if (superbangBtn) {
  superbangBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startSuperbang();
  });
  superbangBtn.addEventListener('click', (e) => {
    // also allow click for desktop if visible
    startSuperbang();
  });
}

/* listen for PC key X */
document.addEventListener('keydown', (e) => {
  if (e.key && e.key.toLowerCase() === 'x') {
    startSuperbang();
  }
});

function updateSuperbangUI() {
  const btn = document.getElementById('superbangBtn');
  if (!btn) return;
  // Show button only on touch devices AND only when selected is emiPigeon or spacePigeon
  if ('ontouchstart' in window && (selected === 'emiPigeon' || selected === 'spacePigeon' || selected === 'lavapigeon') && gameStarted) {
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }

  // update label based on selected pigeon and its cooldown/active state
  if (selected === 'emiPigeon') {
    if (!emiUlt.available && !emiUlt.active) {
      const elapsed = Date.now() - emiUlt.cooldownStartedAt;
      const left = Math.max(0, Math.ceil((emiUlt.cooldown - elapsed) / 1000));
      btn.classList.add('disabled');
      btn.innerText = `SUPERBANG (${left}s)`;
    } else if (emiUlt.active) {
      const elapsed = Date.now() - emiUlt.startedAt;
      const left = Math.max(0, Math.ceil((emiUlt.duration - elapsed) / 1000));
      btn.classList.add('disabled');
      btn.innerText = `SUPERBANG ${left}s`;
    } else {
      btn.classList.remove('disabled');
      btn.innerText = 'SUPERBANG';
    }
  } else if (selected === 'spacePigeon') {
    if (!spaceUlt.available && !spaceUlt.active) {
      const elapsed = Date.now() - spaceUlt.cooldownStartedAt;
      const left = Math.max(0, Math.ceil((spaceUlt.cooldown - elapsed) / 1000));
      btn.classList.add('disabled');
      btn.innerText = `SPACEBANG (${left}s)`;
    } else if (spaceUlt.active) {
      const elapsed = Date.now() - spaceUlt.startedAt;
      const left = Math.max(0, Math.ceil((spaceUlt.duration - elapsed) / 1000));
      btn.classList.add('disabled');
      btn.innerText = `SPACEBANG ${left}s`;
    } else {
      btn.classList.remove('disabled');
      btn.innerText = 'SPACEBANG';
    }
  } else {
    btn.classList.add('disabled');
    btn.innerText = 'SUPERBANG';
  }
}

function update() {
  const stats = pigeons[selected];
  const moveSpeed = stats.speed;
  const dmgBoost = stats.damage;

  // Classic pigeon bonus
  if (isClassicPigeonActive()) {
    stats.damage += 0.6;
    stats.attack += 10;
  }

  if (selected === 'spinPigeon') {
    spinTimer++;
    if (!spinMode && spinTimer >= spinCooldown) {
      spinMode = true;
      spinTimer = 0;
      spinCooldown = Math.floor(Math.random() * 180) + 60;
    } else if (spinMode && spinTimer > 30) {
      spinMode = false;
      spinTimer = 0;
    }
  }

  // Player movement
  if (keys['w']) player.y -= moveSpeed;
  if (keys['s']) player.y += moveSpeed;
  if (keys['a']) player.x -= moveSpeed;
  if (keys['d']) player.x += moveSpeed;

  if (player.x < 0) player.x = 0;
  if (player.y < 0) player.y = 0;
  if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;
  if (player.y + player.h > canvas.height) player.y = canvas.height - player.h;

  // now this part of the code is more understanable
  if (keys[' ']) {
    const shootType = stats.shootType || 'normal_shoot';

    if (shootType === 'candy_shoot') {
      shootCandy(player, bullets, dmgBoost);

    } else if (shootType === 'spin_shoot') {
      if (spinMode) {
        shoot360(player, bullets, stats.damage, 6, 'purple');
      } else {
        shoot(player, bullets, stats.damage, 8);
        bullets[bullets.length - 1].color = 'purple';
      }

    } else if (shootType === 'emishoot') {
      shootEmi(player, bullets, dmgBoost);

    } else if (shootType === 'white_shoot') {
      shootWhite(player, bullets, dmgBoost);

    } else if (shootType === 'green_short') {
      shootGreen(player, bullets, dmgBoost);

    } else if (shootType === 'ball_shoot') {
      shootBall(player, bullets, dmgBoost);

    } else if (shootType === 'purple_shoot') {
      shootPurple(player, bullets, dmgBoost);

    } else if (shootType === 'fireball_shoot') {
      shootFireball(player, bullets, dmgBoost);

    } else if (shootType === 'twoaks_shoot') {
      shootTwoaks(player, bullets, dmgBoost);

    } else if (shootType === 'ice_shoot') {
      shootIce(player, bullets, dmgBoost);
                 
    } else if (shootType === 'golden_rain') {
      shootGolden(player, bullets, dmgBoost);

    } else {
      shoot(player, bullets, dmgBoost);
    }
}


  // Bot movement towards player with prediction
  if (!player.lastX || !player.lastY) {
    player.lastX = player.x;
    player.lastY = player.y;
  }

  const playerSpeedX = player.x - player.lastX;
  const playerSpeedY = player.y - player.lastY;
  const predictionFactor = 0.2;

  const predictedPlayerX = player.x + (playerSpeedX || 0) * predictionFactor;
  const predictedPlayerY = player.y + (playerSpeedY || 0) * predictionFactor;

  const angleToPlayer = Math.atan2(
    predictedPlayerY - (bot.y + bot.h / 2),
    predictedPlayerX - (bot.x + bot.w / 2)
  );

  const botSmooth = 0.6;
  bot.x += Math.cos(angleToPlayer) * bot.speed * botSmooth;
  bot.y += Math.sin(angleToPlayer) * bot.speed * botSmooth;

  // Clamp bot to canvas
  bot.x = Math.max(0, Math.min(canvas.width, bot.x));
  bot.y = Math.max(0, Math.min(canvas.height, bot.y));

  bot.lastX = bot.x;
  bot.lastY = bot.y;

  // Bullets movement (with auto-aim support)
  bullets.forEach(b => {
    if (typeof b.speedX !== "undefined" && typeof b.speedY !== "undefined") {
      b.x += b.speedX;
      b.y += b.speedY;
    } else {
      b.x += b.speed;
    }
  });

  botBullets.forEach(b => b.x += b.speed);

  // Collision: player bullets hit bot
  bullets.forEach(b => {
    if (
      b.x < bot.x + bot.w &&
      b.x + b.w > bot.x &&
      b.y < bot.y + bot.h &&
      b.y + b.h > bot.y
    ) {
      bot.hp -= b.dmg;
      b.hit = true;
    }
  });

  // Collision: bot bullets hit player
  botBullets.forEach(b => {
    if (
      b.x < player.x + player.w &&
      b.x + b.w > player.x &&
      b.y < player.y + player.h &&
      b.y + b.h > player.y
    ) {
      player.hp -= b.dmg;
      b.hit = true;
    }
  });

  // Boss transformation
  if (!bossTransformed && bot.hp < 250) {
    const chance = Math.random();
    if (chance < 0.00015) {
      bossTransformed = true;
      bot.hp = bossForm.hp;
      bot.attack = bossForm.attack;
      bot.speed = bossForm.speed;
      botImg.src = bossForm.img;
      bossFlashCounter = 30;
    }
  }

  // APPLY EMI ULT DAMAGE (if active)
  if (emiUlt.active) {
    // damage per frame (assume ~60fps)
    const dmgPerFrame = emiUlt.damagePerSecond / 60;
    const playerCenterX = player.x + player.w / 2;
    const playerCenterY = player.y + player.h / 2;

    // damage the main bot if inside radius
    const botCenterX = bot.x + bot.w / 2;
    const botCenterY = bot.y + bot.h / 2;
    const dx = botCenterX - playerCenterX;
    const dy = botCenterY - playerCenterY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (dist <= emiUlt.radius) {
      bot.hp -= dmgPerFrame;
    }
  }



  // APPLY SPACE PIGEON ULT (blades) logic
  if (spaceUlt.active) {
    const px = player.x + player.w / 2;
    const py = player.y + player.h / 2;
    // update blade angles and check collisions
    for (let i = 0; i < spaceUlt.blades.length; i++) {
      const blade = spaceUlt.blades[i];
      blade.angle += blade.speed; // rotate
      // compute blade center
      const bx = px + Math.cos(blade.angle) * spaceUlt.orbitRadius;
      const by = py + Math.sin(blade.angle) * spaceUlt.orbitRadius;
      // collision simple check: distance between blade center and bot center
      const botCenterX = bot.x + bot.w / 2;
      const botCenterY = bot.y + bot.h / 2;
      const dx = botCenterX - bx;
      const dy = botCenterY - by;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (!blade.hit && dist <= spaceUlt.bladeHitRadius) {
        // apply damage once per blade per ult
        bot.hp -= spaceUlt.damage;
        blade.hit = true;
      }
    }
  }

  // Movement & physics for Snowy Pigeon (sliding on ice)
if (typeof player.vx === 'undefined') { player.vx = 0; player.vy = 0; }
const accel = 0.9;
const maxSpeed = (pigeons[selected] && pigeons[selected].speed) ? pigeons[selected].speed * 1.6 : 6;
if (selected === 'snowyPigeon') {
  if (keys['w'] || keys['arrowup']) player.vy -= accel;
  if (keys['s'] || keys['arrowdown']) player.vy += accel;
  if (keys['a'] || keys['arrowleft']) player.vx -= accel;
  if (keys['d'] || keys['arrowright']) player.vx += accel;
  player.vx = Math.max(-maxSpeed, Math.min(maxSpeed, player.vx));
  player.vy = Math.max(-maxSpeed, Math.min(maxSpeed, player.vy));
  // slight friction to slide
  player.vx *= 0.985;
  player.vy *= 0.985;
  player.x += player.vx;
  player.y += player.vy;
} else {
  if (keys['w'] || keys['arrowup']) player.y -= (pigeons[selected] && pigeons[selected].speed) ? pigeons[selected].speed : 4;
  if (keys['s'] || keys['arrowdown']) player.y += (pigeons[selected] && pigeons[selected].speed) ? pigeons[selected].speed : 4;
  if (keys['a'] || keys['arrowleft']) player.x -= (pigeons[selected] && pigeons[selected].speed) ? pigeons[selected].speed : 4;
  if (keys['d'] || keys['arrowright']) player.x += (pigeons[selected] && pigeons[selected].speed) ? pigeons[selected].speed : 4;
}

  // END GAME CHECK!
  checkGameEnd();

  // Update UI for superbang (cooldown / text)
  updateSuperbangUI();
}

    function draw() {
      update();
      
      // --- FPS calc ---
      const __now = performance.now();
      const __dt = __now - _lastFrameTime;
      _lastFrameTime = __now;
      const __instFps = 1000 / (__dt > 0 ? __dt : 1);
      _fps = _fps ? (_fpsAlpha * _fps + (1 - _fpsAlpha) * __instFps) : __instFps;
ctx.clearRect(0, 0, canvas.width, canvas.height);

      
      if (selected === 'spinPigeon') {
        if (!player.spinAngle) player.spinAngle = 0;
        player.spinAngle += 0.3; // скорость вращения
        ctx.save();
        ctx.translate(player.x + player.w / 2, player.y + player.h / 2);
        ctx.rotate(player.spinAngle);
        ctx.drawImage(playerImg, -player.w / 2, -player.h / 2, player.w, player.h);
        ctx.restore();
      } else {
        ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
      }

      if (bossTransformed && bossFlashCounter > 0) {
  if (bossFlashCounter % 6 < 3) {
    ctx.drawImage(botImg, bot.x, bot.y, bot.w, bot.h);
  }
  bossFlashCounter--;
} else {
  ctx.drawImage(botImg, bot.x, bot.y, bot.w, bot.h);
}

      bullets.forEach(b => {
  if (b.color === 'candy') {
    const cx = b.x + b.w / 2;
    const cy = b.y + b.h / 2;
    const radius = b.w / 2;
    ctx.save();
    ctx.translate(cx, cy);
    // draw red-white striped candy
    for (let i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.arc(0, 0, radius, i * Math.PI / 4, (i + 0.5) * Math.PI / 4);
      ctx.closePath();
      ctx.fillStyle = i % 2 === 0 ? 'red' : 'white';
      ctx.fill();
    }
    ctx.beginPath();
    ctx.arc(0, 0, radius, 0, Math.PI * 2);
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
  } else {
    ctx.fillStyle = b.color || 'brown';
    ctx.fillRect(b.x, b.y, b.w, b.h);
  }
});

botBullets.forEach(b => {
  ctx.fillStyle = b.color || 'black';
  ctx.fillRect(b.x, b.y, b.w, b.h);
});

      // Draw EMI ult visual (blue circle) when active
      if (emiUlt.active) {
        const cx = player.x + player.w / 2;
        const cy = player.y + player.h / 2;
        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = 'rgba(60,140,255,0.12)';
        ctx.strokeStyle = 'rgba(60,140,255,0.7)';
        ctx.lineWidth = 6;
        ctx.arc(cx, cy, emiUlt.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
      }

      // Draw SPACE ULT blades when active
      if (spaceUlt.active) {
        const px = player.x + player.w / 2;
        const py = player.y + player.h / 2;
        for (let i = 0; i < spaceUlt.blades.length; i++) {
          const blade = spaceUlt.blades[i];
          const bx = px + Math.cos(blade.angle) * spaceUlt.orbitRadius;
          const by = py + Math.sin(blade.angle) * spaceUlt.orbitRadius;

          // triangular blade drawing: rotated isosceles triangle pointing outward
          ctx.save();
          ctx.translate(bx, by);
          ctx.rotate(blade.angle + Math.PI / 2); // align visually
          ctx.beginPath();
          const s = spaceUlt.bladeSize;
          // triangle points
          ctx.moveTo(0, -s);         // top point
          ctx.lineTo(-s * 0.6, s);   // bottom-left
          ctx.lineTo(s * 0.6, s);    // bottom-right
          ctx.closePath();
          ctx.fillStyle = 'rgba(160,64,255,0.95)'; // purple blade
          ctx.fill();
          // blade glow / outline
          ctx.strokeStyle = 'rgba(200,150,255,0.9)';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.restore();

          // optional: debug collision radius (comment out if not needed)
          // ctx.beginPath();
          // ctx.strokeStyle = 'rgba(255,0,0,0.25)';
          // ctx.arc(bx, by, spaceUlt.bladeHitRadius, 0, Math.PI*2);
          // ctx.stroke();
        }
      }

      ctx.fillStyle = 'white';
      ctx.font = '16px sans-serif';
      ctx.fillText(`Player HP: ${Math.max(0, Math.round(player.hp))}`, 10, 20);
      ctx.fillText(`Bot HP: ${Math.max(0, Math.round(bot.hp))}`, 10, 40);

      
      ctx.fillText(`FPS: ${Math.round(_fps)}`, 10, 60);
requestAnimationFrame(draw);
    }

    const joystick = document.getElementById('joystick');
    const shootJoystick = document.getElementById('shootJoystick');
    const shootBtn = document.getElementById('shootBtn');
    if ('ontouchstart' in window) {
      joystick.style.display = 'block';
      
      shootBtn.style.display = 'block';

      let startX, startY;
      joystick.addEventListener('touchstart', e => {
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
      });

      joystick.addEventListener('touchmove', e => {
        
        const touch = e.touches[0];
        let dx = touch.clientX - startX;
        let dy = touch.clientY - startY;

        keys['w'] = dy < -20;
        keys['s'] = dy > 20;
        keys['a'] = dx < -20;
        keys['d'] = dx > 20;
      });

      joystick.addEventListener('touchend', () => {
        keys['w'] = keys['a'] = keys['s'] = keys['d'] = false;
      });

      shootBtn.addEventListener('touchstart', () => keys[' '] = true);
      shootBtn.addEventListener('touchend', () => keys[' '] = false);
    }

    updateCoinsDisplay();
    
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("pigeonism-btn");
    if (btn) {
      btn.addEventListener("click", () => {
        window.location.href = "forum.html";
      });
    }
  });
  
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("about-btn");
    if (btn) {
      btn.addEventListener("click", () => {
        window.location.href = "about.html";
      });
    }
  });


let clickCount = 0;
let clickTimeout = null;

document.getElementById("onlineStatus").addEventListener("click", () => {
  clickCount++;
  if (clickTimeout) clearTimeout(clickTimeout);
  clickTimeout = setTimeout(() => clickCount = 0, 1000);

  if (clickCount >= 3) {
    openCommunityShop();
    clickCount = 0;
  }
});

function openCommunityShop() {
  const shop = document.getElementById("communityShop");
  let spgcoins = parseInt(localStorage.getItem("spgcoins")) || 0;
  document.getElementById("spgcoinDisplay").textContent = `Super Pigeon Coins: ${spgcoins}`;
  shop.style.display = "flex";
}

function closeCommunityShop() {
  document.getElementById("communityShop").style.display = "none";
}

console.log("PigeonBattle. Made by toiletpigeon, enjoy the game like a fat pigeon sitting on a toilet...")

  
/* === SELL LOGIC === */
const pigeonPriceMap = {
  wheelPigeon: 25,
  pigeonCopter: 180,
  feetPigeon: 45,
  dentistPigeon: 49,
  emiPigeon: 100,
  armyPigeon: 55,
  goonPigeon: 69,
  clownPigeon: 130,
  wizardPigeon: 5000,
  sorrelPigeon: 232880,
  feetphone: 210,
  spinPigeon: 300,
  spacePigeon: 65,
  candyPigeon: 220,
  blackarmyPigeon: 100,
  twoaksPigeon: 175,
  tankPigeon: 300,
  hippoPigeon: 75,
  lavapigeon: 120,
  snowyPigeon: 95,
  frostbitePigeon: 80,
  snowdriftPigeon: 185,
  gerbellPigeon: 90,
  diamondPigeon: 110,
  richPigeon: 155,
  default: 0
};

function renderOwnedPigeonsUI() {
  const container = document.getElementById('ownedPigeons');
  container.innerHTML = '';
  const ownedArr = JSON.parse(localStorage.getItem('ownedPigeons') || '[]');
  if (!ownedArr.length) {
    container.innerHTML = '<div style="padding:12px;color:#ccc">U prolly gambled all ur pigeons.. Hope you got a profit</div>';
    return;
  }
  ownedArr.forEach(id => {
    const p = pigeons[id] || { img: 'pigeon.jpg' };
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.gap = '12px';
    div.style.marginBottom = '14px';
    div.innerHTML = `
      <img src="${p.img}" style="width:90px;height:90px;object-fit:cover;border-radius:12px" />
      <div style="flex:1">
        <div style="font-weight:700">${id}</div>
        <div style="font-size:13px;color:#ccc">Price: ${pigeonPriceMap[id] ? pigeonPriceMap[id] + ' PGC' : pigeonPriceMap.default + ' PGC'}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="pigeonism-btn" onclick="selectPigeon('${id}')">Select</button>
        <button class="pigeonism-btn" style="background:#a00" onclick="sellPigeon('${id}', this)">Sell</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function showSellingDialog() {
  return new Promise(resolve => {
    const dialog = document.getElementById('sellDialog');
    const timeEl = document.getElementById('sellTime');
    dialog.style.display = 'flex';
    dialog.setAttribute('aria-hidden','false');
    const secs = Math.floor(Math.random() * 26) + 5;
    let left = secs;
    timeEl.textContent = `Finding a buyer... ${left}s`;
    const interval = setInterval(() => {
      left--;
      timeEl.textContent = `Finding a buyer... ${left}s`;
      if (left <= 0) {
        clearInterval(interval);
        dialog.style.display = 'none';
        dialog.setAttribute('aria-hidden','true');
        resolve(true);
      }
    }, 1000);
  });
}

function sellPigeon(id, btnEl) {
  if (btnEl) {
    btnEl.disabled = true;
    btnEl.textContent = 'Selling...';
  }
  showSellingDialog().then(() => {
    const arr = JSON.parse(localStorage.getItem('ownedPigeons') || '[]');
    const idx = arr.indexOf(id);
    if (idx !== -1) arr.splice(idx, 1);
    localStorage.setItem('ownedPigeons', JSON.stringify(arr));
    const price = pigeonPriceMap[id] || pigeonPriceMap.default;
    coins = (parseInt(localStorage.getItem('pigeonCoins') || coins) || 0) + price;
    localStorage.setItem('pigeonCoins', coins);
    updateCoinsDisplay();
    renderOwnedPigeonsUI();
    toast(`${id} sold — +${price} PGC`);
  }).finally(() => {
    if (btnEl) {
      btnEl.disabled = false;
      btnEl.textContent = 'Sell';
    }
  });
}

document.getElementById('pigeonsButton').onclick = () => {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('pigeonsMenu').style.display = 'flex';
  renderOwnedPigeonsUI();
};

const origBuy = window.buy;
window.buy = function(id,cost){
  origBuy && origBuy(id,cost);
  setTimeout(renderOwnedPigeonsUI, 150);
};

renderOwnedPigeonsUI();

document.addEventListener("DOMContentLoaded", () => {
  const isMedal = localStorage.getItem("isMedal");
  const giftDialog = document.getElementById("giftDialog");
  const giftBtn = document.getElementById("giftOkBtn");

  if (!isMedal) {
    giftDialog.style.display = "flex";
  }

  if (giftBtn) {
    giftBtn.addEventListener("click", () => {
      giftDialog.style.display = "none";
      localStorage.setItem("isMedal", "true");
    });
  }
});

</script>


<style>
#reloadDisplay {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 10px;
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 8px 12px;
  border-radius: 999px;
  font-family: 'Poppins', sans-serif;
  display: none;
  z-index: 100000;
  font-weight: 700;
  letter-spacing: 0.4px;
}
</style>
<div id="reloadDisplay">Reloading... 2s</div>
<script>
(function(){
  const LIMIT_MS = 2000; // max continuous shooting
  const RELOAD_MS = 2000; // reload duration
  let shootHoldSince = null;
  let shootHeld = false;
  window.isReloading = false;
  const reloadEl = document.getElementById('reloadDisplay');

  function showReload(seconds){
    reloadEl.innerText = `Reloading... ${seconds}s`;
    reloadEl.style.display = 'block';
  }
  function hideReload(){
    reloadEl.style.display = 'none';
  }

  function triggerReload(){
    if (window.isReloading) return;
    window.isReloading = true;
    shootHeld = false;
    try { keys[' '] = false; } catch(e){}
    const start = Date.now();
    let lastSec = Math.ceil(RELOAD_MS/1000);
    showReload(lastSec);
    const t = setInterval(() => {
      const passed = Date.now() - start;
      const left = Math.max(0, RELOAD_MS - passed);
      const sec = Math.ceil(left/1000);
      if (sec !== lastSec) {
        lastSec = sec;
        showReload(sec);
      }
      if (left <= 0) {
        clearInterval(t);
        window.isReloading = false;
        hideReload();
      }
    }, 100);
  }

  setInterval(() => {
    if (window.isReloading) return;
    if (shootHeld) {
      if (!shootHoldSince) shootHoldSince = Date.now();
      else {
        if (Date.now() - shootHoldSince > LIMIT_MS) {
          triggerReload();
          shootHoldSince = null;
        }
      }
    } else {
      shootHoldSince = null;
    }
  }, 80);

  function startShooting(){
    if (window.isReloading) return;
    shootHeld = true;
    try { keys[' '] = true; } catch(e){}
    if (!shootHoldSince) shootHoldSince = Date.now();
  }
  function stopShooting(){
    shootHeld = false;
    try { keys[' '] = false; } catch(e){}
    shootHoldSince = null;
  }

  document.addEventListener('keydown', function(e){
    const code = e.code || e.key;
    if (code === 'Space' || code === ' '){
      e.preventDefault();
      startShooting();
    }
  }, {passive:false});
  document.addEventListener('keyup', function(e){
    const code = e.code || e.key;
    if (code === 'Space' || code === ' '){
      e.preventDefault();
      stopShooting();
    }
  });

  const canvas = document.getElementById('gameCanvas');
  if (canvas){
    canvas.addEventListener('mousedown', function(e){
      if (e.button === 0) startShooting();
    });
    canvas.addEventListener('mouseup', function(e){
      if (e.button === 0) stopShooting();
    });
    canvas.addEventListener('touchstart', function(e){ startShooting(); }, {passive:false});
    canvas.addEventListener('touchend', function(e){ stopShooting(); });
  }

  const oldShootBtn = document.getElementById('shootBtn');
  if (oldShootBtn){
    const newShootBtn = oldShootBtn.cloneNode(true);
    oldShootBtn.parentNode.replaceChild(newShootBtn, oldShootBtn);
    newShootBtn.addEventListener('touchstart', function(e){ e.preventDefault(); startShooting(); }, {passive:false});
    newShootBtn.addEventListener('touchend', function(e){ e.preventDefault(); stopShooting(); });
    newShootBtn.addEventListener('mousedown', function(e){ startShooting(); });
    newShootBtn.addEventListener('mouseup', function(e){ stopShooting(); });
  }

  // --- override ALL shoot* functions ---
  function patchAllShoots(){
    for (const key in window){
      if (typeof window[key] === 'function' && key.startsWith('shoot')){
        if (!window[key]._isPatched){
          const oldFn = window[key];
          const newFn = function(){
            if (window.isReloading) return;
            return oldFn.apply(this, arguments);
          };
          newFn._isPatched = true;
          window[key] = newFn;
        }
      }
    }
  }
  patchAllShoots();
  setInterval(patchAllShoots, 2000);

})();

// Final part
if (!localStorage.getItem("firstLaunchWarningShown")) {
  console.warn("⚠️ Warning: The first launch can take a long time!");
  localStorage.setItem("firstLaunchWarningShown", "true");
}



function showNewPigeonAchievement(name, imgSrc) {
  try {
    const el = document.getElementById('newPigeonAchievement');
    const nameEl = document.getElementById('newPigeonName');
    const imgEl = document.getElementById('newPigeonImg');
    nameEl.textContent = name;
    imgEl.src = imgSrc;
    el.style.display = 'flex';
    el.classList.remove('hide');
    el.classList.add('show');
    // auto hide after 4 seconds
    setTimeout(() => {
      el.classList.remove('show');
      el.classList.add('hide');
      setTimeout(()=> el.style.display = 'none', 600);
    }, 4000);
  } catch(e) { console.error(e); }
}


(function(){
  function isNewYearMidnight(date) {
    return date.getMonth() === 0 && date.getDate() === 1 && date.getHours() === 0 && date.getMinutes() === 0;
  }

  function hideAllMenus() {
    const ids = ['menu','shop','pigeonsMenu','communityShop'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
  }

  function createNYOverlay() {
    // overlay
    const ov = document.createElement('div');
    ov.id = 'nyOverlay';
    Object.assign(ov.style, {
      position: 'fixed',
      inset: '0',
      zIndex: 999999,
      display: 'flex',
      justifyContent: 'center',
      alignItems: 'center',
      pointerEvents: 'none',
      overflow: 'hidden',
      background: 'radial-gradient(circle at 50% 20%, rgba(255,255,255,0.06), rgba(0,0,0,0.7))'
    });

    // big text
    const txt = document.createElement('div');
    txt.innerText = 'HAPPY NEW YEAR!!!!!!!!!!!!!!!!!';
    Object.assign(txt.style, {
      position: 'absolute',
      top: '10%',
      width: '100%',
      textAlign: 'center',
      fontSize: '8vw',
      fontWeight: '900',
      fontFamily: "'Press Start 2P', sans-serif",
      color: 'white',
      textShadow: '0 6px 20px rgba(0,0,0,0.6), 0 0 20px rgba(255,255,255,0.08)',
      pointerEvents: 'none',
    });
    ov.appendChild(txt);

    // helper to spawn pigeon img
    function spawnPigeon(src) {
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'pigeon';
      const size = 40 + Math.random()*180; // px
      Object.assign(img.style, {
        position: 'absolute',
        left: (Math.random()*120 - 10) + '%', // allow off-screen spawn
        top: '-20%',
        width: size + 'px',
        height: 'auto',
        transform: `rotate(${Math.random()*60-30}deg)`,
        opacity: 0.95,
        pointerEvents: 'none',
        willChange: 'transform, top, left'
      });
      ov.appendChild(img);

      // animate falling / flying across screen
      const duration = 4000 + Math.random()*6000;
      const endLeft = (Math.random()*120 - 10);
      img.animate([
        { transform: `translateY(0px) rotate(${Math.random()*60-30}deg)`, left: img.style.left, top: '-20%' },
        { transform: `translateY(${70 + Math.random()*120}vh) rotate(${Math.random()*360-180}deg)`, left: endLeft + '%', top: (60 + Math.random()*30) + '%' }
      ], {
        duration: duration,
        easing: 'cubic-bezier(.2,.8,.2,1)',
        fill: 'forwards'
      });

      // remove after finished
      setTimeout(()=> img.remove(), duration + 200);
    }

    // spawn wave of pigeons
    function spawnWave() {
      // try to pick pigeon images from assets array if available
      const pool = (window.assets || []).filter(a => /\.(jpg|png|jpeg|webp)$/i.test(a));

      const count = 12 + Math.floor(Math.random()*18);
      for (let i=0;i<count;i++) {
        const src = pool[Math.floor(Math.random()*pool.length)];
        // small stagger
        setTimeout(()=> spawnPigeon(src), i * 120);
      }
    }

    // periodic waves
    const waveInterval = setInterval(spawnWave, 1800);
    // initial burst
    spawnWave();

    // allow closing overlay after 20s (keeps overlay for a while then remove)
    setTimeout(() => {
      clearInterval(waveInterval);
      // let remaining animations finish, then remove
      setTimeout(()=> {
        ov.remove();
      }, 3000);
    }, 20000);

    document.body.appendChild(ov);
  }

  // run on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const now = new Date;
      if (isNewYearMidnight(now)) {
        hideAllMenus();
        createNYOverlay();
      }
    } catch(e) { console.error('NY easter egg error', e); }
  });
})();

document.getElementById('goonNFTsButton').onclick = () => {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('goonNFTsPage').style.display = 'flex';
  document.getElementById('goonCoinsDisplay').innerText = `Coins: ${coins}`;
  renderOwnedNFTs();
};


function renderOwnedNFTs() {
  const listEl = document.getElementById('ownedNFTList') || document.getElementById('ownedNFTsContainer');
  if (!listEl) return;
  const owned = JSON.parse(localStorage.getItem('ownedNFTs') || '[]');
  if (!owned || owned.length === 0) {
    listEl.innerHTML = '<div style="opacity:.6">none</div>';
    return;
  }
  listEl.innerHTML = owned.map(n => `
    <div class="owned-nft-row" style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#081018;margin:8px 0;">
      <img src="${n.img || n.id + '.jpg' }" alt="${n.name}" style="width:56px;height:56px;border-radius:8px;object-fit:cover;box-shadow:0 6px 16px rgba(0,0,0,.6)">
      <div style="flex:1;text-align:left">
        <div style="font-weight:700">${n.name}</div>
        <div style="font-size:12px;opacity:.6">${n.id}</div>
      </div>
      <button onclick="selectNFT('${n.id}')" style="padding:8px 10px;border-radius:10px;border:none;background:linear-gradient(90deg,#0d6efd,#00c3ff);color:white;font-weight:800">Select</button>
    </div>`).join('');
}

document.addEventListener('DOMContentLoaded', () => {
  renderOwnedNFTs();
});

function closeGoonNFTs() {
  document.getElementById('goonNFTsPage').style.display = 'none';
  document.getElementById('mainPage').style.display = 'block'; // still in development
}

</script>


  <div id="caseResultOverlay">
    <h1 id="caseResultTitle"></h1>
    <img id="caseResultImg" src="" alt="" style="display:none;">
    <p id="caseResultText"></p>
    <button id="caseCloseBtn" onclick="closeCaseResult()">OK</button>
  </div>

<div id="achievement" class="achievement">New pigeon unlocked!</div>


<!-- GoonNFTs Page -->
<style>
  #goonNFTsPage {
    display:none;
    flex-direction:column;
    align-items:center;
    padding:20px;
    background:#000;
    color:white;
    min-height:100vh;
    max-height: 90vh;
    overflow-y: auto;
    padding: 10px;
  }
  .nft-card {
    background:#111;
    border-radius:18px;
    padding:18px;
    margin:10px;
    width:260px;
    box-shadow:0 0 15px rgba(0,0,0,0.6);
    text-align:center;
  }
  .nft-btn {
    background:linear-gradient(135deg,#0d6efd,#00c3ff);
    padding:10px 14px;
    border:none;
    border-radius:12px;
    font-weight:700;
    color:white;
    margin-top:8px;
    width:100%;
  }
  .owned-list {
    margin-top:20px;
    width:100%;
    max-width:300px;
    text-align:center;
  }

  /* 3D glow frame */
.glow3d {
  background: linear-gradient(180deg, rgba(6,10,13,0.85), rgba(14,18,22,0.9));
  border-radius: 18px;
  padding: 14px;
  box-shadow:
    0 6px 26px rgba(0,200,150,0.06),
    0 0 40px rgba(0,240,180,0.08),
    inset 0 0 20px rgba(0,120,90,0.06);
  border: 1px solid rgba(0,200,150,0.12);
  transition: transform .18s ease, box-shadow .18s ease;
}
.glow3d:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 50px rgba(0,200,150,0.12); }
.emerald-card { border-image: linear-gradient(90deg,#00ffbf,#00c3ff) 1; }
.nft-image-wrap img { display:block; }
  .glow-simple {
  box-shadow: 0 0 18px rgba(120, 200, 255, 0.85);
}

</style>

<div id="goonNFTsPage">
  <h2>GoonNFTs</h2>
  <div id="goonCoinsDisplay">Coins: 0</div>

  <div class="nft-card">
    <img src="frostbitepigeon.jpg" style="width:100%;border-radius:12px;">
    <p>Frostbite Pigeon<br>26,270 coins</p>
    <button class="nft-btn" onclick="buyNFT({id:'frostbiteNFT', name:'Frostbite Pigeon'}, 26270)">Buy Frostbite</button>
  </div>

  <div class="nft-card" style="background:#332700;">
    <img src="goldenpigeon.jpg" style="width:100%;border-radius:12px;">
    <p>Golden Pigeon<br>17,837 coins</p>
    <button class="nft-btn" onclick="buyNFT({id:'goldNFT', name:'Golden Pigeon'}, 17837)">Buy Golden</button>
  </div>

<div class="nft-card glow3d emerald-card">
  <div class="nft-image-wrap" style="perspective:800px;">
    <img src="emeraldpigeon.jpg" alt="Emerald Pigeon" style="width:100%;border-radius:14px;transform:translateZ(12px) scale(1.02);">
  </div>
  <h4 style="margin:10px 0 6px;font-weight:900">Emerald Pigeon</h4>
  <div style="opacity:.85;margin-bottom:8px">83,991 pigeon coins</div>
  <button class="nft-btn" onclick="buyNFT({id:'emeraldNFT', name:'Emerald Pigeon', img:'emeraldpigeon.jpg'}, 83991)">Buy Emerald</button>
</div>

  <h3 class="nft-collection-title">❄ Frostbite Collection</h3>

<div class="nft-card glow-simple" style="background:black;">
  <img src="frostbite_7468.png" style="width:100%;border-radius:12px;">
  <p>
    <b>Frostbite Pigeon #7468</b><br>
    Glow Effect<br>
    14,328 PGC
  </p>
  <button class="nft-btn"
    onclick="buyNFT({id:'frostbite7468', name:'Frostbite Pigeon #7468', img:'frostbite_7468.png'}, 14328)">
    Buy
  </button>
</div>

<div class="nft-card" style="background:white;color:black;">
  <img src="frostbite_6789.png" style="width:100%;border-radius:12px;">
  <p>
    <b>Frostbite Pigeon #6789</b><br>
    No effects<br>
    95,328 PGC
  </p>
  <button class="nft-btn"
    onclick="buyNFT({id:'frostbite6789', name:'Frostbite Pigeon #6789', img:'frostbite_6789.png'}, 95328)">
    Buy
  </button>
</div>

<div class="nft-card glow-simple" style="background:#ff8c1a;">
  <img src="frostbite_99023.png" style="width:100%;border-radius:12px;">
  <p>
    <b>Frostbite Pigeon #99023</b><br>
    Glow Effect<br>
    44,238 PGC
  </p>
  <button class="nft-btn"
    onclick="buyNFT({id:'frostbite99023', name:'Frostbite Pigeon #99023', img:'frostbite_99023.png'}, 44238)">
    Buy
  </button>
</div>
    


  <h3>Owned NFTs</h3>
  <div class="owned-list" id="ownedNFTList">none</div>

  <button class="nft-btn" onclick="closeShop()">Back</button>
</div>

    <style>
#scareOverlay {
  position: fixed;
  inset: 0;
  background: black;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999999;
}

#scareText {
  color: red;
  font-size: 3em;
  font-weight: 900;
  opacity: 0;
  animation: scareFade 4s ease forwards;
}

@keyframes scareFade {
  0% { opacity: 0 }
  20% { opacity: 1 }
  80% { opacity: 1 }
  100% { opacity: 0 }
}
</style>

<div id="scareOverlay">
  <div id="scareText">WHY DID YOU DO THAT</div>
</div>

<script>
(function () {
  if (localStorage.getItem("isHacked") === "true") {
    document.body.innerHTML = "";
    document.body.style.background = "black";
    throw new Error("Blocked");
  }

  let lastCoins = null; 

  window.checkScareAntiCheat = function (currentCoins) {
  
    if (lastCoins === null) {
      lastCoins = currentCoins;
      return;
    }

    let diff = currentCoins - lastCoins;

    if (diff >= 9999) {
      const ov = document.getElementById("scareOverlay");
      if (ov) ov.style.display = "flex";

      setTimeout(() => {
        localStorage.setItem("isHacked", "true");
      }, 3500);

      setTimeout(() => {
        document.body.innerHTML = "";
        document.body.style.background = "black";
      }, 4200);

      throw new Error("Cheater detected");
    }

    lastCoins = currentCoins;
  };
})();
</script>
</body>
</html>

